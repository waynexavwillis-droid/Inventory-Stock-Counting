<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory System â€” Adjust Stock</title>

<!-- Auth gate with role check -->
<script>
  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role');
  if (!AUTH_OK || !AUTH_USER) { window.location.replace('login.html'); }
  else if (AUTH_ROLE === 'viewer') { window.location.replace('viewer.html'); }
  function logout(){
    localStorage.removeItem('auth_v1');
    localStorage.removeItem('auth_user');
    localStorage.removeItem('auth_role');
    localStorage.removeItem('auth_time');
    window.location.replace('login.html');
  }
</script>

<style>
  :root{
    /* match goal.html palette */
    --nav-w:260px;
    --bg:#f6f7f8;        /* page background */
    --panel:#fff;        /* cards / panels */
    --ink:#111;          /* main text */
    --muted:#6b7280;     /* secondary text */
    --line:#e5e7eb;      /* borders */
    --accent:#111;       /* controls (kept neutral to match goal.html hover) */
  }

  html,body{height:100%}
  body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--ink)}
  h1,h2,h3{color:var(--ink)}
  .content{padding:20px;padding-top:80px;min-height:100vh;box-sizing:border-box}
  input,button,select,textarea{padding:8px;margin:4px;font-family:inherit}

  /* buttons match goal.html */
  button{
    background:linear-gradient(#fafafa,#f3f4f6);
    border:1px solid var(--line);
    color:var(--ink);
    border-radius:8px; cursor:pointer
  }
  button:hover{background:#111;color:#fff;border-color:#111}

  /* Sidebar + hamburger (light style) */
  #menu-check{display:none}
  .hamburger{
    position:fixed;left:12px;top:12px;width:32px;display:flex;flex-direction:column;gap:7px;
    cursor:pointer;user-select:none;z-index:1200;transition:transform .3s
  }
  .hamburger .bar{
    height:3px;background:#111;border-radius:10px;transition:transform .35s,opacity .25s,width .35s
  }
  .hamburger .bar1,.hamburger .bar3{width:18px}.hamburger .bar2{width:28px}
  #menu-check:checked+label.hamburger{transform:translateX(var(--nav-w))}
  #menu-check:checked+label.hamburger .bar1{transform:translateY(10px) rotate(45deg);width:28px}
  #menu-check:checked+label.hamburger .bar2{opacity:0}
  #menu-check:checked+label.hamburger .bar3{transform:translateY(-10px) rotate(-45deg);width:28px}

  .sidebar{
    position:fixed;inset:0 auto 0 0;width:var(--nav-w);background:#f3f4f6;padding:20px;box-sizing:border-box;
    transform:translateX(-100%);transition:.3s;z-index:1100;overflow:auto;border-right:1px solid var(--line);
    box-shadow:0 10px 30px rgba(0,0,0,.18)
  }
  .sidebar a,.sidebar button{
    display:block;width:100%;margin-bottom:10px;padding:10px;text-align:left;border-radius:8px;text-decoration:none;
    color:inherit;border:1px solid var(--line);background:#fff
  }
  .sidebar a:hover{background:#111;color:#fff;border-color:#111}
  #menu-check:checked~.sidebar{transform:translateX(0)}
  label.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;transition:.3s;z-index:1090}
  #menu-check:checked~label.overlay{opacity:1;visibility:visible}

  /* Grid cards (light) */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:16px}
  .card{
    --card-bg:var(--panel);--card-text:var(--ink);
    width:190px;height:274px;background:var(--card-bg);border-radius:20px;position:relative;overflow:visible;
    transition:.2s ease;box-shadow:0 8px 20px rgba(0,0,0,.08);border:1px solid var(--line);color:var(--card-text)
  }
  .card:hover{transform:translateY(-4px)}
  .badge-lowok{
    position:absolute;top:12px;right:12px;padding:.25em .5em;border-radius:999px;font-size:.7em;font-weight:600;opacity:0;transform:scale(.9);
    transition:all .2s
  }
  .badge-lowok--low{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}
  .badge-lowok--ok{background:#e6f7ef;color:#166534;border:1px solid #bbf7d0}
  .badge-new{
    position:absolute;top:-10px;right:-10px;background:#e11d48;color:#fff;padding:.35em .55em;border-radius:999px;font-weight:700;font-size:.7em;
    box-shadow:0 8px 18px rgba(0,0,0,.15);cursor:pointer
  }
  .card__image{
    width:100%;height:100px;border-radius:12px;background:#f3f4f6;background-size:cover;background-position:center;position:relative;overflow:hidden;border:1px solid var(--line)
  }
  .img-edit-btn{
    position:absolute;top:6px;left:6px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-size:14px;
    border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.95);color:var(--ink);cursor:pointer
  }
  .img-view-btn{
    position:absolute;top:6px;right:6px;height:26px;display:flex;align-items:center;justify-content:center;font-size:12px;padding:0 8px;
    border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.95);color:var(--ink);cursor:pointer
  }
  .qty-badge{
    position:absolute;bottom:8px;right:8px;background:#111;color:#fff;font-size:12px;padding:2px 6px;border-radius:999px;opacity:.9
  }
  .card__text{display:flex;flex-direction:column;gap:.25em;padding:0 10px}
  .card__title{font-size:1.1em;margin:6px 0 0;font-weight:700}
  .card__description{color:var(--muted);font-size:.78em;margin:0}
  .card__actions{display:flex;justify-content:center;gap:12px;margin-top:8px}
  .card__button{
    width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;
    background:#fff;border:1px solid var(--line);color:var(--ink)
  }
  .card__button:hover{background:#111;color:#fff;border-color:#111}
  .card__button--minus{background:#fff}
  .card__button--trash{background:#fff;color:var(--ink);border:1px solid var(--line)}

  /* Modals + toasts */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:9999}
  .modal.open{display:flex}
  .modal-card{width:95%;max-width:520px;background:#fff;border-radius:8px;padding:16px 18px;box-shadow:0 20px 40px rgba(0,0,0,.15);border:1px solid var(--line);color:#111}
  .modal-card h3{margin:0 0 10px;color:#111}
  .modal-card label{display:block;margin:10px 0 4px;font-size:14px;color:#111}
  .input-container{position:relative;margin:8px 0}
  .input{
    width:100%;padding:10px;height:40px;border:2px solid #111;border-top:none;border-bottom:none;font-size:16px;background:transparent;outline:none;
    box-shadow:7px 7px 0 0 #111;transition:.5s;box-sizing:border-box
  }
  .topline,.underline{position:absolute;background-color:#111;height:2px;right:0;transition:.5s}
  .topline{width:0;top:0}.underline{width:0;bottom:0}
  .input:focus~.topline{width:35%}.input:focus~.underline{width:100%}
  .label{position:absolute;top:10px;left:10px;color:#111;transition:.5s;transform:scale(0);z-index:-1;background:#fff;padding:0 4px}
  .input:focus~.label{top:-10px;transform:scale(1)}
  .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}

  .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
  .toast{background:#111;color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .toast--warn{background:#b45309}.toast--error{background:#991b1b}.toast__close{margin-left:12px;cursor:pointer;font-weight:700}
</style>
</head>
<body>

<input id="menu-check" type="checkbox" />
<label for="menu-check" class="hamburger" aria-label="Toggle menu" aria-controls="side" role="button" tabindex="0">
  <span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span>
</label>

<nav class="sidebar" id="side" role="navigation" aria-label="Main">
  <a href="index.html">Add New Stock</a>
  <a href="adjust.html">Adjust Stock</a>
  <a href="location.html">Location</a>
  <a href="goal.html">Set Stock Count Goal</a>
  <a href="history.html">History</a>
  <a href="status.html">Status</a>
  <hr>
  <button onclick="logout()">Logout</button>
</nav>
<label class="overlay" for="menu-check" aria-hidden="true"></label>

<div class="toast-wrap" id="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<main class="content">
  <section aria-labelledby="adjustPageTitle">
    <h2 id="adjustPageTitle">Adjust Stock</h2>
    <div id="stockGrid" class="grid"></div>
  </section>
</main>

<!-- Adjust dialog -->
<div id="adjustModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="adj-title">
  <div class="modal-card">
    <h3 id="adj-title">Adjust Stock</h3>
    <div id="adj-subtitle" style="color:#6b7280"></div>
    <label for="adj-amount">Amount</label>
    <input id="adj-amount" type="number" min="1" step="1" value="1" placeholder="Enter amount" inputmode="numeric" class="input">
    <label for="adj-location">Location</label>
    <select id="adj-location" class="input">
      <option>Old warehouse</option><option>New warehouse</option>
    </select>
    <div class="input-container">
      <input id="adj-name" type="text" class="input" placeholder=" " readonly>
      <span class="topline"></span><span class="underline"></span>
      <label for="adj-name" class="label">Your name (auto)</label>
    </div>
    <div class="input-container">
      <input id="adj-reason" type="text" class="input" placeholder=" ">
      <span class="topline"></span><span class="underline"></span>
      <label for="adj-reason" class="label">Reason</label>
    </div>
    <div class="input-container">
      <input id="adj-by" type="text" class="input" placeholder=" ">
      <span class="topline"></span><span class="underline"></span>
      <label for="adj-by" class="label">Adjusted by (name)</label>
    </div>
    <div class="modal-actions">
      <button id="adj-cancel">Cancel</button>
      <button id="adj-confirm">Confirm</button>
    </div>
  </div>
</div>

<!-- Delete dialog -->
<div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="del-title">
  <div class="modal-card">
    <h3 id="del-title">Delete Item</h3>
    <div id="del-subtitle" style="color:#6b7280"></div>
    <div class="input-container">
      <input id="del-name" type="text" class="input" placeholder=" " readonly>
      <span class="topline"></span><span class="underline"></span>
      <label for="del-name" class="label">Your name (auto)</label>
    </div>
    <div class="input-container">
      <input id="del-reason" type="text" class="input" placeholder=" ">
      <span class="topline"></span><span class="underline"></span>
      <label for="del-reason" class="label">Reason (e.g., discontinued)</label>
    </div>
    <div class="input-container">
      <input id="del-by" type="text" class="input" placeholder=" ">
      <span class="topline"></span><span class="underline"></span>
      <label for="del-by" class="label">Adjusted by (name)</label>
    </div>
    <div class="modal-actions">
      <button id="del-cancel">Cancel</button>
      <button id="del-confirm">Delete</button>
    </div>
  </div>
</div>

<!-- Image viewer modal -->
<div id="imageModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="img-title">
  <div class="modal-card">
    <h3 id="img-title">Image</h3>
    <img id="img-view" src="" alt="" style="width:100%; max-height:70vh; object-fit:contain; border:1px solid var(--line); border-radius:8px;" />
    <div class="modal-actions">
      <a id="img-open" href="#" target="_blank" rel="noopener" style="margin-right:auto;color:#111;text-decoration:underline">Open in new tab</a>
      <button id="img-close">Close</button>
    </div>
  </div>
</div>

<!-- Hidden file picker -->
<input type="file" id="hiddenFileInput" accept="image/*,.jpg,.jpeg,.png,.gif,.webp,.bmp,.heic,.heif" capture="environment" style="display:none" />

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    getFirestore, collection, doc, addDoc, updateDoc, deleteDoc,
    onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
    authDomain: "epedu-inventory-database.firebaseapp.com",
    projectId: "epedu-inventory-database",
    storageBucket: "epedu-inventory-database.appspot.com",
    messagingSenderId: "124437251040",
    appId: "1:124437251040:web:4989c73efc2f4afbf22185",
    measurementId: "G-GFEEP49VRP"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) {}
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const st   = getStorage(app);
  signInAnonymously(auth).catch(console.error);

  const CURRENT_USER = localStorage.getItem('auth_user') || 'Unknown';

  /* Sidebar ARIA */
  const menuCheck = document.getElementById('menu-check');
  const hamb = document.querySelector('label.hamburger');
  function syncAria(){ hamb.setAttribute('aria-expanded', String(menuCheck.checked)); }
  menuCheck.addEventListener('change', syncAria); syncAria();

  /* Toasts */
  const toastWrap = document.getElementById('toast-wrap');
  function toast(msg, type='info', timeout=3200){
    const el = document.createElement('div');
    el.className = 'toast' + (type==='warn' ? ' toast--warn' : type==='error' ? ' toast--error' : '');
    el.innerHTML = `${escapeHtml(msg)} <span class="toast__close" aria-label="Dismiss" role="button">Ã—</span>`;
    toastWrap.appendChild(el);
    const close = ()=>{ if (el && el.parentNode) el.parentNode.removeChild(el); };
    el.querySelector('.toast__close').addEventListener('click', close);
    if (timeout>0) setTimeout(close, timeout);
  }
  const notify = toast;

  /* Utils */
  function escapeHtml(s){ return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function csvEscape(v){ const s = (v ?? '').toString(); return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s; }
  function toLocalDateTime(ts){ if (!ts) return ''; const d = ts.toDate ? ts.toDate() : new Date(ts); return isNaN(+d)?'':d.toLocaleString(); }
  function normLoc(raw){
    const s=(raw||'').trim().toLowerCase();
    if (s.startsWith('old')) return 'Old warehouse';
    if (s.startsWith('new')) return 'New warehouse';
    if (['old warehouse','new warehouse'].includes(s)) return s.replace(/\b\w/g,m=>m.toUpperCase());
    return null;
  }
  function totalQty(item){ return (Number(item.qtyOld) || 0) + (Number(item.qtyNew) || 0); }
  function withCacheBuster(url){ if (!url) return url; const sep = url.includes('?') ? '&' : '?'; return `${url}${sep}v=${Date.now()}`; }

  const SUPPORTED_IMAGE_TYPES=["image/jpeg","image/jpg","image/png","image/gif","image/webp","image/bmp","image/heic","image/heif"];
  function isSupportedImage(file){ if (!file) return false; if (file.type && SUPPORTED_IMAGE_TYPES.includes(file.type.toLowerCase())) return true; const n=(file.name||"").toLowerCase(); return /\.(jpe?g|png|gif|webp|bmp|heic|heif)$/.test(n); }
  function guessContentType(file){ const t=file?.type||""; if(t) return t; const n=(file?.name||"").toLowerCase();
    if(/\.jpe?g$/.test(n))return"image/jpeg"; if(/\.png$/.test(n))return"image/png"; if(/\.gif$/.test(n))return"image/gif";
    if(/\.webp$/.test(n))return"image/webp"; if(/\.bmp$/.test(n))return"image/bmp"; if(/\.heic$/.test(n))return"image/heic";
    if(/\.heif$/.test(n))return"image/heif"; return"application/octet-stream"; }

  /* Firestore refs */
  const colInventory   = collection(db, "inventory");
  const colAdjustments = collection(db, "adjustments");

  /* State */
  let inventory = [];
  const lowState = new Map();

  /* Live listeners */
  onSnapshot(colInventory, (snap) => { inventory = snap.docs.map(d => ({ id:d.id, ...d.data() })); renderStockGrid(); checkLowStockAlerts(); });

  /* Image viewer */
  const imageModal   = document.getElementById('imageModal');
  const imgView      = document.getElementById('img-view');
  const imgTitle     = document.getElementById('img-title');
  const imgOpenLink  = document.getElementById('img-open');
  const imgCloseBtn  = document.getElementById('img-close');
  function openImageViewer(url, title='Image'){ imgView.src = url; imgView.alt = title; imgTitle.textContent = title; imgOpenLink.href = url || '#'; imageModal.classList.add('open'); }
  function closeImageViewer(){ imageModal.classList.remove('open'); imgView.src = ''; imgView.alt = ''; }
  imgCloseBtn.addEventListener('click', closeImageViewer);
  imageModal.addEventListener('click', e => { if (e.target.id === 'imageModal') closeImageViewer(); });
  window.openImageViewer = openImageViewer;

  /* Render grid */
  function renderStockGrid() {
    const grid = document.getElementById('stockGrid'); if (!grid) return;
    grid.innerHTML = '';
    inventory.forEach((item) => {
      const total = totalQty(item);
      const isLow = (item.goal > 0) && (total <= item.goal);
      const card = document.createElement('div'); card.className = 'card';
      const bgUrl = item.img ? withCacheBuster(item.img) : '';
      const safeBgUrl = bgUrl ? bgUrl.replace(/"/g,'%22').replace(/'/g,'%27') : '';
      const bgStyle = bgUrl ? `style="background-image:url('${safeBgUrl}')"` : '';
      card.innerHTML = `
        <div class="badge-lowok ${isLow ? 'badge-lowok--low' : 'badge-lowok--ok'}" style="opacity:1; transform:scale(1);">${isLow ? 'LOW' : 'OK'}</div>
        ${item.isNew ? `<div class="badge-new" title="Dismiss">NEW</div>` : ''}
        <div class="card__content">
          <div class="card__image" ${bgStyle}>
            <button class="img-edit-btn" title="Set image" aria-label="Set image">ðŸ–¼</button>
            <button class="img-view-btn" title="View image" aria-label="View image">View Image</button>
            <span class="qty-badge" title="Old: ${item.qtyOld ?? 0}, New: ${item.qtyNew ?? 0}">Qty: ${total}</span>
          </div>
          <div class="card__text">
            <h3 class="card__title" title="${escapeHtml(item.name)}">${escapeHtml(item.name)}</h3>
            <!-- NEW: split quantities line -->
            <p class="card__description">Old: ${item.qtyOld ?? 0} | New: ${item.qtyNew ?? 0}</p>
            <!-- Keep total + goal for quick context -->
            <p class="card__description">Total: ${total} â€¢ Goal: ${item.goal || 0}</p>
          </div>
          <div class="card__actions">
            <div class="card__button" data-plus aria-label="Add" title="Add (Shift=Set image)">+</div>
            <div class="card__button card__button--minus" data-minus aria-label="Minus" title="Minus">â€“</div>
            <div class="card__button card__button--trash" data-del-id="${item.id}" aria-label="Delete" title="Delete">ðŸ—‘</div>
          </div>
        </div>`;
      card.querySelector('.img-edit-btn').addEventListener('click', () => openImagePickerById(item.id));
      card.querySelector('.img-view-btn').addEventListener('click', () => {
        const current = inventory.find(i=>i.id===item.id);
        if (!current || !current.img) { notify('No image set yet. Click ðŸ–¼ to add one.','warn'); return; }
        openImageViewer(withCacheBuster(current.img), `Item: ${current.name}`);
      });
      if (item.isNew) card.querySelector('.badge-new')?.addEventListener('click', async ()=>{ try{ await updateDoc(doc(db,"inventory", item.id), { isNew:false }); }catch(e){} });
      card.querySelector('[data-plus]').addEventListener('click', (e)=>{ if (e.shiftKey){ openImagePickerById(item.id); return; } openAdjustDialogById(item.id,'add'); });
      card.querySelector('[data-minus]').addEventListener('click', ()=> openAdjustDialogById(item.id,'sub'));
      card.querySelector('[data-del-id]').addEventListener('click', ()=> openDeleteDialogById(item.id));
      grid.appendChild(card);
    });
  }

  /* Low-stock toasts */
  function checkLowStockAlerts(){
    for (const item of inventory){
      const goal = Number.isFinite(item.goal) ? item.goal : 0;
      const total = totalQty(item);
      const isLow = goal > 0 && total <= goal;
      const prev = lowState.get(item.id) || false;
      if (isLow && !prev){ notify(`LOW: "${item.name}" at ${total} (goal ${goal}).`, 'warn', 6000); }
      lowState.set(item.id, isLow);
    }
  }

  /* Adjust dialog & actions */
  let pending = { index:null, mode:'add' };
  function openAdjustDialog(index, mode) {
    pending = { index, mode };
    const item = inventory[index]; const total = totalQty(item);
    document.getElementById('adj-title').textContent = `${mode === 'add' ? 'Add to' : 'Minus from'} "${item.name}"`;
    document.getElementById('adj-subtitle').textContent = `Current total: ${total} (Old: ${item.qtyOld ?? 0}, New: ${item.qtyNew ?? 0})`;
    document.getElementById('adj-amount').value = '1';
    document.getElementById('adj-name').value = CURRENT_USER;
    document.getElementById('adj-location').value = 'Old warehouse';
    document.getElementById('adj-reason').value = ''; document.getElementById('adj-by').value = '';
    document.getElementById('adjustModal').classList.add('open');
    setTimeout(() => document.getElementById('adj-amount').focus(), 0);
  }
  function openAdjustDialogById(id, mode){
    const index = inventory.findIndex(i => i.id === id);
    if (index < 0) return;
    openAdjustDialog(index, mode);
  }
  window.openAdjustDialogById = openAdjustDialogById;
  function closeAdjustDialog(){ document.getElementById('adjustModal').classList.remove('open'); }
  document.getElementById('adj-cancel').addEventListener('click', closeAdjustDialog);
  document.getElementById('adjustModal').addEventListener('click', (e) => { if (e.target.id === 'adjustModal') closeAdjustDialog(); });
  document.getElementById('adjustModal').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('adj-confirm').click(); } });

  document.getElementById('adj-confirm').addEventListener('click', async () => {
    try {
      if (pending?.index == null) { closeAdjustDialog(); return; }
      const item = inventory[pending.index]; if (!item) { closeAdjustDialog(); return; }
      const amountRaw = document.getElementById('adj-amount').value;
      const amt = parseInt(amountRaw, 10);
      const loc = normLoc(document.getElementById('adj-location').value);
      const reason = (document.getElementById('adj-reason').value || '').trim();
      const adjustedBy = (document.getElementById('adj-by').value || '').trim();
      if (!Number.isInteger(amt) || amt <= 0) { notify('Enter a positive integer amount.','warn'); return; }
      if (!loc) { notify('Location must be "Old warehouse" or "New warehouse".','warn'); return; }
      if (!reason || !adjustedBy) { notify('Please fill Reason and Adjusted by (name).','warn'); return; }
      const mode = pending.mode === 'sub' ? 'sub' : 'add';
      const delta = mode === 'add' ? amt : -amt;
      const prevOld = Number(item.qtyOld ?? 0), prevNew = Number(item.qtyNew ?? 0);
      if (mode === 'sub') {
        if (loc === 'Old warehouse' && amt > prevOld) { notify(`Not enough stock in Old warehouse (have ${prevOld}).`,'warn'); return; }
        if (loc === 'New warehouse' && amt > prevNew) { notify(`Not enough stock in New warehouse (have ${prevNew}).`,'warn'); return; }
      }
      let newOld = prevOld, newNew = prevNew;
      if (loc === 'Old warehouse') newOld = prevOld + delta;
      if (loc === 'New warehouse') newNew = prevNew + delta;
      newOld = Math.max(0, newOld); newNew = Math.max(0, newNew);
      const newTotal = newOld + newNew;

      await updateDoc(doc(db, "inventory", item.id), { qtyOld: newOld, qtyNew: newNew, qty: newTotal });
      await addDoc(colAdjustments, {
        ts: serverTimestamp(), item: item.name, itemId: item.id, location: loc, delta,
        actor: CURRENT_USER, reason, adjustedBy, qtyAfterOld: newOld, qtyAfterNew: newNew, qtyAfter: newTotal
      });

      notify(`${mode === 'add' ? 'Added' : 'Subtracted'} ${Math.abs(delta)} ${loc === 'Old warehouse' ? 'to/from Old' : 'to/from New'} for "${item.name}".`);
      closeAdjustDialog();
    } catch(err) { console.error(err); notify('Failed to adjust stock','error'); }
  });

  /* Delete item */
  let pendingDeleteId = null;
  function getItemById(id){ return inventory.find(i => i.id === id); }
  function total(item){ return (Number(item.qtyOld) || 0) + (Number(item.qtyNew) || 0); }
  function openDeleteDialogById(id) {
    const item = getItemById(id); if (!item) return;
    pendingDeleteId = id;
    const t = total(item);
    document.getElementById('del-title').textContent = `Delete "${item.name}"`;
    document.getElementById('del-subtitle').textContent = `This will remove the item and log a history entry with -${t} (Qty after: 0).`;
    document.getElementById('del-name').value = CURRENT_USER;
    document.getElementById('del-reason').value = '';
    document.getElementById('del-by').value = '';
    document.getElementById('deleteModal').classList.add('open');
    setTimeout(() => document.getElementById('del-reason').focus(), 0);
  }
  window.openDeleteDialogById = openDeleteDialogById;
  function closeDeleteDialog(){ document.getElementById('deleteModal').classList.remove('open'); }
  document.getElementById('del-cancel').addEventListener('click', closeDeleteDialog);
  document.getElementById('deleteModal').addEventListener('click', e => { if (e.target.id === 'deleteModal') closeDeleteDialog(); });
  document.getElementById('deleteModal').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('del-confirm').click(); } });
  document.getElementById('del-confirm').addEventListener('click', async () => {
    if (!pendingDeleteId) return closeDeleteDialog();
    const actor = CURRENT_USER;
    const reason = document.getElementById('del-reason').value.trim();
    const adjustedBy = document.getElementById('del-by').value.trim();
    if (!reason || !adjustedBy) { notify('Please fill in Reason and Adjusted by (name).','warn'); return; }
    const removed = getItemById(pendingDeleteId);
    if (!removed) { pendingDeleteId = null; closeDeleteDialog(); return; }
    const prevTotal = total(removed);
    try{
      await addDoc(collection(db, "adjustments"), { ts: serverTimestamp(), item: removed.name, itemId: removed.id, location: 'ALL', delta: -prevTotal, actor, reason, adjustedBy, qtyAfterOld: 0, qtyAfterNew: 0, qtyAfter: 0 });
      await deleteDoc(doc(db,"inventory", removed.id));
      notify('Item deleted');
    } catch(err){ console.error(err); notify('Failed to delete item','error'); }
    pendingDeleteId = null; closeDeleteDialog();
  });

  /* Image picker */
  let imgTargetIndex=null;
  const fileInput=document.getElementById('hiddenFileInput');
  function isLikelyHttpUrl(s){ const u=(s||'').trim(); return /^https?:\/\//i.test(u) || /^data:image\//i.test(u); }
  function openImagePicker(index){
    imgTargetIndex=index;
    const choice=prompt("Set image:\n- Paste an image URL (http/https) and press OK, OR\n- Leave blank to choose a file (uploads to Firebase Storage).");
    if (choice && choice.trim()){
      if (!isLikelyHttpUrl(choice.trim())) { notify('Please enter a valid http(s) or data: image URL','warn'); imgTargetIndex=null; return; }
      setItemImageFromURL(choice.trim());
    } else fileInput.click();
  }
  function openImagePickerById(id){
    const idx = inventory.findIndex(i=>i.id===id);
    if (idx>=0) openImagePicker(idx);
  }
  window.openImagePickerById = openImagePickerById;

  fileInput.addEventListener('change', async (e)=>{
    const file=e.target.files && e.target.files[0]; e.target.value='';
    if(!file || imgTargetIndex===null) return;
    if (!isSupportedImage(file)) { notify(`Unsupported image format: ${file.type || file.name}`,'warn', 6000); imgTargetIndex = null; return; }
    const item=inventory[imgTargetIndex];
    try{
      const ref  = storageRef(st, `itemImages/${item.id}/${Date.now()}_${(file.name||'photo').replace(/[^\w.\-]+/g,'_')}`);
      await uploadBytes(ref, file, { contentType: file.type || "application/octet-stream" });
      const url = await getDownloadURL(ref);
      await updateDoc(doc(db,"inventory",item.id),{ img:url, isNew:true });
      openImageViewer(withCacheBuster(url), `Item: ${item.name}`);
    }catch(err){ console.error(err); notify('Upload failed','error'); }
    imgTargetIndex=null;
  });
  async function setItemImageFromURL(url){
    if(imgTargetIndex===null) return; const item=inventory[imgTargetIndex];
    try{ await updateDoc(doc(db,"inventory",item.id),{ img:url, isNew:true }); openImageViewer(withCacheBuster(url), `Item: ${item.name}`); }
    catch(err){ console.error(err); notify('Failed to set image URL','error'); }
    imgTargetIndex=null;
  }
  window.setItemImageFromURL=setItemImageFromURL;

  /* ESC closes modals */
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape'){
      document.getElementById('adjustModal').classList.remove('open');
      document.getElementById('deleteModal').classList.remove('open');
      document.getElementById('imageModal').classList.remove('open');
    }
  });
</script>
</body>
</html>
