<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory System â€” Add New Stock</title>

<!-- Auth gate -->
<script>
  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role');
  if (!AUTH_OK || !AUTH_USER) location.replace('login.html');
  else if (AUTH_ROLE === 'viewer') location.replace('viewer.html');
  function logout(){
    localStorage.clear();
    location.replace('login.html');
  }
</script>

<style>
:root{
  --bg:#F7F4EA;--panel:#EEE6D8;--ink:#1F2937;--line:#D9CFC1;--accent:#0EA5A4;
}
body{margin:0;font-family:Arial;background:var(--bg);color:var(--ink)}
button{cursor:pointer}

.scanner-btn{
  position:fixed;bottom:24px;right:24px;width:64px;height:64px;
  border-radius:50%;background:var(--accent);color:#fff;
  border:none;font-size:28px;z-index:1000;
}

.scanner-modal{
  position:fixed;inset:0;background:rgba(0,0,0,.9);
  display:none;align-items:center;justify-content:center;
  z-index:2000;
}
.scanner-modal.active{display:flex}

.scanner-content{
  background:var(--panel);padding:20px;border-radius:16px;
  max-width:600px;width:100%;position:relative;
}

.scanner-close{
  position:absolute;top:10px;right:10px;font-size:22px;
}

.scanner-viewport{
  width:100%;height:350px;background:#000;border-radius:8px;
  overflow:hidden;position:relative;
}

.scanner-viewport video{
  width:100%;height:100%;object-fit:cover;
}

.scanner-overlay{
  position:absolute;inset:15%;border:2px solid var(--accent);
  pointer-events:none;
}

.scanner-result,.add-form{
  margin-top:12px;background:#fff;padding:12px;border-radius:8px;
}
.add-form{display:none}
.add-form.active{display:block}

.toast-wrap{position:fixed;right:16px;bottom:16px}
.toast{background:#eee;padding:10px;border-radius:8px;margin-top:8px}
</style>
</head>

<body>

<button class="scanner-btn" onclick="openScanner()">ðŸ“·</button>

<div class="scanner-modal" id="scannerModal">
  <div class="scanner-content">
    <button class="scanner-close" onclick="closeScanner()">Ã—</button>
    <h3>Scan Barcode</h3>

    <div class="scanner-viewport" id="scannerViewport">
      <div class="scanner-overlay"></div>
    </div>

    <div class="scanner-result" id="scannerResult" style="display:none">
      <strong>Scanned Code:</strong> <span id="scannedCode"></span>
    </div>

    <div class="add-form" id="addForm">
      <input id="scannedItemName" placeholder="Item name">
      <input id="scannedItemQty" type="number" value="1" min="1">
      <select id="scannedItemLoc">
        <option>Old warehouse</option>
        <option>New warehouse</option>
        <option>Office</option>
      </select>
      <button onclick="addScannedItem()">Add Item</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toast-wrap"></div>

<!-- Quagga -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, collection, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
  authDomain: "epedu-inventory-database.firebaseapp.com",
  projectId: "epedu-inventory-database"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const colInventory = collection(db,"inventory");

const toastWrap = document.getElementById('toast-wrap');
function notify(msg){
  const d=document.createElement('div');
  d.className='toast';d.textContent=msg;
  toastWrap.appendChild(d);
  setTimeout(()=>d.remove(),3000);
}

// =========================
// SCANNER LOGIC (FIXED)
// =========================
let scannerActive=false;
let scannedBarcode='';

window.openScanner=()=>{
  document.getElementById('scannerModal').classList.add('active');
  startScanner();
};

window.closeScanner=()=>{
  document.getElementById('scannerModal').classList.remove('active');
  stopScanner();
};

function startScanner(){
  if(scannerActive) return;

  Quagga.init({
    inputStream:{
      name:"Live",
      type:"LiveStream",
      target:document.querySelector('#scannerViewport'),
      constraints:{
        facingMode:{ideal:"environment"},
        width:{ideal:1280},
        height:{ideal:720}
      }
    },
    locator:{patchSize:"medium",halfSample:true},
    numOfWorkers:1,
    decoder:{
      readers:[
        "ean_reader","ean_8_reader",
        "upc_reader","upc_e_reader",
        "code_128_reader","code_39_reader"
      ]
    },
    locate:true
  },err=>{
    if(err){console.error(err);notify("Camera error");return;}
    Quagga.start();
    scannerActive=true;
  });

  Quagga.onDetected(onDetected);
}

function stopScanner(){
  if(!scannerActive) return;
  Quagga.offDetected(onDetected);
  Quagga.stop();
  scannerActive=false;
}

function onDetected(res){
  const code=res?.codeResult?.code;
  if(!code) return;

  scannedBarcode=code;
  document.getElementById('scannedCode').textContent=code;
  document.getElementById('scannerResult').style.display='block';
  document.getElementById('addForm').classList.add('active');
  notify("Scanned: "+code);
  stopScanner();
}

window.addScannedItem=async()=>{
  const name=scannedItemName.value.trim();
  const qty=parseInt(scannedItemQty.value,10);
  const loc=scannedItemLoc.value;
  if(!name||qty<=0) return notify("Invalid input");

  await addDoc(colInventory,{
    name,qty,location:loc,barcode:scannedBarcode
  });
  notify("Item added");
  closeScanner();
};
</script>
</body>
</html>
