<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory System — Status</title>

<script>
  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role');
  if (!AUTH_OK || !AUTH_USER) { window.location.replace('login.html'); }
  else if (AUTH_ROLE === 'viewer') { window.location.replace('viewer.html'); }
  function logout(){
    localStorage.removeItem('auth_v1'); localStorage.removeItem('auth_user');
    localStorage.removeItem('auth_role'); localStorage.removeItem('auth_time');
    window.location.replace('login.html');
  }
</script>

<style>
  /* ==== Light theme based on #F7F4EA ==== */
  :root{
    --nav-w:260px;

    /* Theme */
    --bg:#F7F4EA;        /* page background */
    --panel:#EEE6D8;     /* cards / panels */
    --ink:#1F2937;       /* primary text */
    --muted:#6B7280;     /* muted text */
    --line:#D9CFC1;      /* borders/outlines */
    --accent:#0EA5A4;    /* teal accent */
    --chip:#EDE7DA;      /* subtle chip / badge bg */
    --header-bg:#F0E8DB; /* soft tint */

    /* Status chips */
    --chip-loan-bg:#DCFCE7; --chip-loan-ink:#065F46;
    --chip-rent-bg:#FEF3C7; --chip-rent-ink:#92400E;
    --chip-where-bg:#E0E7FF; --chip-where-ink:#3730A3;
  }

  html,body{height:100%}
  body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--ink)}
  h2{color:var(--ink)}
  .content{padding:20px;padding-top:80px;min-height:100vh;box-sizing:border-box}

  /* Controls — legibility & theme consistency */
  input,button,select,textarea{
    padding:8px;margin:4px;font-family:inherit;
    color:var(--ink);
    background:var(--panel);
    border:1px solid var(--line);
    caret-color:var(--ink);
  }
  input::placeholder, textarea::placeholder{ color:var(--muted); opacity:1 }

  button{
    border-radius:8px; cursor:pointer; transition:.15s ease;
  }
  button:hover{ background:var(--accent); color:#fff; border-color:var(--accent) }

  /* Primary action buttons */
  .action-btn{
    background:var(--accent);
    color:#fff;
    border:1px solid var(--accent);
  }
  .action-btn:hover{ filter:brightness(.95) }

  /* Hamburger + sidebar */
  #menu-check{display:none}
  .hamburger{
    position:fixed;left:12px;top:12px;width:32px;display:flex;flex-direction:column;gap:7px;
    cursor:pointer;user-select:none;z-index:1200;transition:transform .3s
  }
  .hamburger .bar{
    height:3px;background:var(--ink);border-radius:10px;
    transition:transform .35s,opacity .25s,width .35s
  }
  .hamburger .bar1,.hamburger .bar3{width:18px}.hamburger .bar2{width:28px}
  #menu-check:checked+label.hamburger{transform:translateX(var(--nav-w))}
  #menu-check:checked+label.hamburger .bar1{transform:translateY(10px) rotate(45deg);width:28px}
  #menu-check:checked+label.hamburger .bar2{opacity:0}
  #menu-check:checked+label.hamburger .bar3{transform:translateY(-10px) rotate(-45deg);width:28px}

  .sidebar{
    position:fixed;inset:0 auto 0 0;width:var(--nav-w);
    background:var(--panel);padding:20px;box-sizing:border-box;
    transform:translateX(-100%);transition:.3s;z-index:1100;overflow:auto;
    border-right:1px solid var(--line);
    box-shadow:0 10px 30px rgba(0,0,0,.08)
  }
  .sidebar a,.sidebar button{
    display:block;width:100%;margin-bottom:10px;padding:10px;text-align:left;
    border-radius:8px;text-decoration:none;color:inherit;border:1px solid var(--line);background:transparent
  }
  .sidebar a:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  #menu-check:checked~.sidebar{transform:translateX(0)}
  label.overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;visibility:hidden;transition:.3s;z-index:1090}
  #menu-check:checked~label.overlay{opacity:1;visibility:visible}

  /* Toolbar */
  .status-toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px}

  /* Fancy input (search) themed */
  .input-container{position:relative;margin:8px 4px;min-width:280px;flex:1}
  .input{
    width:100%;padding:10px;height:40px;
    border:2px solid var(--line);
    border-top:none;border-bottom:none;
    font-size:16px;background:transparent;outline:none;
    box-shadow:7px 7px 0 0 var(--line);
    transition:.5s;box-sizing:border-box;
    color:var(--ink);caret-color:var(--ink);
  }
  .topline,.underline{position:absolute;background-color:var(--line);height:2px;right:0;transition:.5s}
  .topline{width:0;top:0}.underline{width:0;bottom:0}
  .input:focus~.topline{width:35%}.input:focus~.underline{width:100%}
  .label{
    position:absolute;top:10px;left:10px;color:var(--ink);
    transition:.5s;transform:scale(0);z-index:-1;background:var(--bg);padding:0 4px
  }
  .input:focus~.label{top:-10px;transform:scale(1)}

  /* Status cards */
  .status-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
  .status-card{
    background:var(--panel);border:1px solid var(--line);border-radius:16px;
    box-shadow:0 8px 24px rgba(15,23,42,.06);color:var(--ink);
    display:flex;flex-direction:column;gap:10px;padding:14px 14px 12px
  }
  .status-card__top{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:12px;gap:8px}
  .status-card__title{font-weight:700;margin:2px 0 4px}
  .status-meta{font-size:12px;color:var(--muted);display:grid;grid-template-columns:auto auto;gap:4px 14px}
  .status-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px;border-top:1px dashed var(--line);padding-top:8px}
  .status-chip{background:var(--chip);border-radius:999px;padding:2px 8px;font-size:12px}
  .chip--loan{background:var(--chip-loan-bg);color:var(--chip-loan-ink)}
  .chip--rent{background:var(--chip-rent-bg);color:var(--chip-rent-ink)}
  .chip--where{background:var(--chip-where-bg);color:var(--chip-where-ink)}
  .status-del,.status-edit{
    background:transparent;border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer;color:#374151
  }
  .status-del:hover,.status-edit:hover{background:#F9FAFB}
  .status-amt{font-weight:800;color:var(--ink)}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:9999}
  .modal.open{display:flex}
  .modal-card{
    width:95%;max-width:520px;background:var(--panel);border-radius:8px;padding:16px 18px;
    box-shadow:0 20px 40px rgba(0,0,0,.12);border:1px solid var(--line);color:var(--ink)
  }
  .modal-card h3{margin:0 0 10px;color:var(--ink)}
  .modal-card label{display:block;margin:10px 0 4px;font-size:14px;color:var(--ink)}
  .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}

  /* Toasts */
  .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
  .toast{background:#E9E2D6;color:var(--ink);padding:10px 12px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.12)}
  .toast--warn{background:#F2C97D;color:#4A2E00}.toast--error{background:#F3B8B8;color:#711313}.toast__close{margin-left:12px;cursor:pointer;font-weight:700}
</style>
</head>
<body>

<input id="menu-check" type="checkbox" />
<label for="menu-check" class="hamburger" aria-label="Toggle menu" aria-controls="side" role="button" tabindex="0">
  <span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span>
</label>

<nav class="sidebar" id="side" role="navigation" aria-label="Main">
  <a href="index.html">Add New Stock</a>
  <a href="adjust.html">Adjust Stock</a>
  <a href="location.html">Location</a>
  <a href="goal.html">Set Stock Count Goal</a>
  <a href="history.html">History</a>
  <a href="status.html">Status</a>
  <hr>
  <button onclick="logout()">Logout</button>
</nav>
<label class="overlay" for="menu-check" aria-hidden="true"></label>

<div class="toast-wrap" id="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<main class="content">
  <section aria-labelledby="statusPageTitle">
    <h2 id="statusPageTitle">Status</h2>

    <div class="status-toolbar">
      <div class="input-container">
        <input id="status-search" type="text" class="input" placeholder=" ">
        <span class="topline"></span><span class="underline"></span>
        <label for="status-search" class="label">Search order / item / remarks…</label>
      </div>
      <button class="action-btn" id="status-add-btn">+ New Status</button>
    </div>

    <div id="statusList" class="status-list"></div>
    <div style="color:var(--muted)">Track individual loan/rent sets here. Use the + button to add a record.</div>
  </section>
</main>

<!-- Status modal (used for Add + Edit) -->
<div id="statusModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="status-title">
  <div class="modal-card">
    <h3 id="status-title">Add Status</h3>

    <label for="st-order">Order ID</label>
    <input id="st-order" type="text" placeholder="e.g., ORDER 543" class="input">

    <label for="st-item">Item Name</label>
    <input id="st-item" type="text" placeholder="e.g., 3D WRITING PEN" class="input">

    <label for="st-qty">Quantity</label>
    <input id="st-qty" type="number" min="1" step="1" value="1" placeholder="Quantity" class="input">

    <label for="st-type">Status</label>
    <select id="st-type" class="input"><option>Loan</option><option>Rent</option></select>

    <label for="st-where">Location</label>
    <select id="st-where" class="input">
      <option>Client</option>
      <option>On the way back</option>
      <option>Office</option>
    </select>

    <label for="st-remarks">Remarks</label>
    <textarea id="st-remarks" rows="3" placeholder="Optional notes…" class="input" style="height:auto"></textarea>

    <div class="modal-actions">
      <button id="st-cancel">Cancel</button>
      <button id="st-save" class="action-btn">Save</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  /* ---------- Firebase ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
    authDomain: "epedu-inventory-database.firebaseapp.com",
    projectId: "epedu-inventory-database",
    storageBucket: "epedu-inventory-database.appspot.com",
    messagingSenderId: "124437251040",
    appId: "1:124437251040:web:4989c73efc2f4afbf22185",
    measurementId: "G-GFEEP49VRP"
  };
  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) {}
  const auth = getAuth(app);
  const db   = getFirestore(app);
  signInAnonymously(auth).catch(console.error);

  const CURRENT_USER = localStorage.getItem('auth_user') || 'Unknown';

  /* ---------- Sidebar ARIA ---------- */
  const menuCheck = document.getElementById('menu-check');
  const hamb = document.querySelector('label.hamburger');
  function syncAria(){ hamb.setAttribute('aria-expanded', String(menuCheck.checked)); }
  menuCheck.addEventListener('change', syncAria); syncAria();

  /* ---------- Toasts ---------- */
  const toastWrap = document.getElementById('toast-wrap');
  function escapeHtml(s){ return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function notify(msg, type='info', timeout=3200){
    const el = document.createElement('div');
    el.className = 'toast' + (type==='warn' ? ' toast--warn' : type==='error' ? ' toast--error' : '');
    el.innerHTML = `${escapeHtml(msg)} <span class="toast__close" aria-label="Dismiss" role="button">×</span>`;
    toastWrap.appendChild(el);
    const close = ()=>{ if (el && el.parentNode) el.parentNode.removeChild(el); };
    el.querySelector('.toast__close').addEventListener('click', close);
    if (timeout>0) setTimeout(close, timeout);
  }

  /* ---------- Firestore ---------- */
  const colStatuses = collection(db, "statuses");

  /* ---------- State & live updates ---------- */
  let statuses = [];
  onSnapshot(query(colStatuses, orderBy("ts","desc")), (snap) => {
    statuses = snap.docs.map(d => ({ id:d.id, ...d.data() }));
    renderStatuses();
  });

  /* ---------- UI wiring ---------- */
  const statusModal = document.getElementById('statusModal');
  const stOpenBtn   = document.getElementById('status-add-btn');
  const stCancel    = document.getElementById('st-cancel');
  const stSave      = document.getElementById('st-save');
  const stSearch    = document.getElementById('status-search');

  let editingId = null; // when set, Save will update instead of create

  function openStatusModalNew(){
    editingId = null;
    document.getElementById('status-title').textContent = 'Add Status';
    document.getElementById('st-order').value   = '';
    document.getElementById('st-item').value    = '';
    document.getElementById('st-qty').value     = '1';
    document.getElementById('st-type').value    = 'Loan';
    document.getElementById('st-where').value   = 'Client';
    document.getElementById('st-remarks').value = '';
    statusModal.classList.add('open');
    setTimeout(()=>document.getElementById('st-order').focus(),0);
  }

  function openStatusModalEdit(row){
    editingId = row.id;
    document.getElementById('status-title').textContent = 'Edit Status';
    document.getElementById('st-order').value   = row.order || '';
    document.getElementById('st-item').value    = row.item  || '';
    document.getElementById('st-qty').value     = row.qty   ?? 1;
    document.getElementById('st-type').value    = row.status || 'Loan';
    document.getElementById('st-where').value   = row.where  || 'Client';
    document.getElementById('st-remarks').value = row.remarks || '';
    statusModal.classList.add('open');
    setTimeout(()=>document.getElementById('st-order').focus(),0);
  }

  function closeStatusModal(){ statusModal.classList.remove('open'); }

  stOpenBtn.addEventListener('click', openStatusModalNew);
  stCancel.addEventListener('click', closeStatusModal);
  statusModal.addEventListener('click', e => { if (e.target.id === 'statusModal') closeStatusModal(); });
  statusModal.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); stSave.click(); } });

  stSave.addEventListener('click', async ()=>{
    const order   = document.getElementById('st-order').value.trim();
    const item    = document.getElementById('st-item').value.trim();
    const qty     = parseInt(document.getElementById('st-qty').value,10);
    const stype   = document.getElementById('st-type').value; // Loan | Rent
    const where   = document.getElementById('st-where').value; // Client | On the way back | Office
    const remarks = document.getElementById('st-remarks').value.trim();
    if (!order || !item || !Number.isInteger(qty) || qty<=0){
      notify('Please fill Order ID, Item Name, and a positive Quantity.','warn'); return;
    }
    try{
      if (editingId){
        await updateDoc(doc(db,'statuses',editingId), {
          order, item, qty, status:stype, where, remarks,
          editor: CURRENT_USER, updatedAt: serverTimestamp()
        });
        notify('Status updated');
      } else {
        await addDoc(colStatuses, {
          ts:serverTimestamp(), order, item, qty, status:stype, where, remarks, actor:CURRENT_USER
        });
        notify('Status saved');
      }
      closeStatusModal();
    }catch(err){ console.error(err); notify('Failed to save status','error'); }
  });

  /* ---------- Render ---------- */
  function renderStatuses(){
    const wrap = document.getElementById('statusList'); if (!wrap) return;
    wrap.innerHTML = '';
    let rows = statuses.slice();
    const q = (stSearch?.value || '').trim().toLowerCase();
    if (q) rows = rows.filter(r =>
      (r.order||'').toLowerCase().includes(q) ||
      (r.item||'').toLowerCase().includes(q) ||
      (r.remarks||'').toLowerCase().includes(q) ||
      (r.where||'').toLowerCase().includes(q)
    );
    for (const r of rows){
      const div = document.createElement('div'); div.className='status-card';
      const dt = r.ts?.toDate ? r.ts.toDate().toLocaleString() : (r.ts ? new Date(r.ts).toLocaleString() : '');
      const chipClass = (r.status||'').toLowerCase()==='rent' ? 'chip--rent' : 'chip--loan';
      const whereTxt = r.where || 'Client';
      div.innerHTML = `
        <div class="status-card__top">
          <span>${escapeHtml(dt || '')}</span>
          <div style="display:flex; gap:8px; align-items:center;">
            <span class="status-chip ${chipClass}">${escapeHtml(r.status || '')}</span>
            <span class="status-chip chip--where" title="Location">${escapeHtml(whereTxt)}</span>
            <button class="status-edit" data-status-edit="${r.id}" title="Edit">✏️</button>
            <button class="status-del" data-status-del="${r.id}" title="Delete">🗑</button>
          </div>
        </div>
        <div class="status-card__title">Order: ${escapeHtml(r.order || '')}</div>
        <div class="status-meta">
          <div>Item Name</div><div>${escapeHtml(r.item || '')}</div>
          <div>Quantity</div><div class="status-amt">${r.qty ?? ''}</div>
          <div>Location</div><div>${escapeHtml(whereTxt)}</div>
        </div>
        ${r.remarks ? `<div class="status-row"><div style="color:var(--muted);">Remarks</div><div>${escapeHtml(r.remarks)}</div></div>` : ''}`;
      wrap.appendChild(div);
    }
    // wire edit + delete
    wrap.querySelectorAll('[data-status-edit]').forEach(btn=>{
      btn.onclick = (e)=>{
        const id = e.currentTarget.getAttribute('data-status-edit');
        const row = statuses.find(s=>s.id===id);
        if (row) openStatusModalEdit(row);
      };
    });
    wrap.querySelectorAll('[data-status-del]').forEach(btn=>{
      btn.onclick = async (e)=>{
        const id = e.currentTarget.getAttribute('data-status-del');
        if (!id) return;
        if (!confirm('Delete this status record?')) return;
        try{ await deleteDoc(doc(db,'statuses',id)); notify('Status deleted'); }
        catch(err){ console.error(err); notify('Failed to delete status','error'); }
      };
    });
  }
  stSearch?.addEventListener('input', renderStatuses);

  /* ---------- ESC closes modal ---------- */
  window.addEventListener('keydown', (e) => { if (e.key === 'Escape'){ statusModal.classList.remove('open'); }});

  /* Helpers used in render */
  function escapeHtml(s){ return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
</script>
</body>
</html>
