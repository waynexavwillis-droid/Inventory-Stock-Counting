<!DOCTYPE html>
<html lang="en" data-accent="cyan">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="color-scheme" content="dark">
<title>Inventory System — Add New Stock</title>

<!-- Auth gate with role check -->
<script>
  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role'); // 'editor' | 'viewer'
  if (!AUTH_OK || !AUTH_USER) { window.location.replace('login.html'); }
  else if (AUTH_ROLE === 'viewer') { window.location.replace('viewer.html'); }
  function logout(){
    localStorage.removeItem('auth_v1');
    localStorage.removeItem('auth_user');
    localStorage.removeItem('auth_role');
    localStorage.removeItem('auth_time');
    window.location.replace('login.html');
  }
</script>

<style>
  /* ---------- THEME: Modern & Sleek (Dark) ---------- */
  :root{
    --nav-w:260px;

    /* Core palette */
    --bg:#111827;              /* Near-black */
    --panel:#1F2937;           /* Charcoal */
    --ink:#F3F4F6;             /* Text */
    --muted:#D1D5DB;           /* Muted text */
    --line:#374151;            /* Slate line/border */

    /* Accent (default cyan) and its ink */
    --accent:#06B6D4;          /* Cyan */
    --accent-ink:#0B1220;      /* Dark text on bright accent */

    /* Elevation / effects */
    --shadow-lg:0 10px 30px rgba(0,0,0,.45);
    --shadow-md:0 6px 20px rgba(0,0,0,.35);
    --ring:0 0 0 3px color-mix(in oklab, var(--accent) 35%, transparent);

    /* Controls */
    --ctrl-bg:#0F172A;         /* Input bg (slightly lighter than page bg) */
    --ctrl-border:#374151;
    --ctrl-bg-hover:#0B1323;

    /* Toast semantic colors (dark-friendly) */
    --warn:#B45309;
    --error:#991B1B;
    --ok:#059669;
  }

  /* Optional quick toggle to neon accent via data attribute */
  html[data-accent="neon"]{ --accent:#22D3EE; }

  /* Base layout */
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    background:var(--bg);
    color:var(--ink);
  }
  ::selection{ background: color-mix(in oklab, var(--accent) 45%, transparent); color:#081018; }

  h1,h2,h3{ color:var(--ink); margin:0 0 .5rem }
  .content{
    padding:20px;
    padding-top:80px;
    min-height:100vh;
    box-sizing:border-box;
  }

  /* Inputs & buttons */
  input,button,select,textarea{
    padding:12px;
    margin:4px;
    font-family:inherit;
    font-size:16px;
    border-radius:10px;
    border:1px solid var(--ctrl-border);
    background:var(--ctrl-bg);
    color:var(--ink);
    outline:none;
    transition:.24s ease;
    -webkit-tap-highlight-color: transparent;
  }
  input::placeholder{ color: color-mix(in oklab, var(--muted) 75%, transparent); }
  input:focus, select:focus, textarea:focus{
    border-color: var(--accent);
    box-shadow: var(--ring);
  }

  button{
    cursor:pointer;
    background: linear-gradient(0deg, color-mix(in oklab, var(--panel) 70%, black) 0%, var(--panel) 100%);
    border-color: var(--line);
  }
  button:hover{
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
    border-color: color-mix(in oklab, var(--accent) 40%, var(--line));
  }
  button:active{ transform: translateY(0); }

  /* Accent button variant */
  .btn-accent{
    background: var(--accent);
    border-color: var(--accent);
    color: var(--accent-ink);
    font-weight:700;
  }
  .btn-accent:hover{
    filter: brightness(.96);
    box-shadow: 0 8px 30px color-mix(in oklab, var(--accent) 25%, transparent);
  }

  /* Sidebar + hamburger (dark) */
  #menu-check{ display:none }
  .hamburger{
    position:fixed; left:12px; top:12px; width:42px; height:42px;
    display:flex; align-items:center; justify-content:center;
    gap:6px; cursor:pointer; user-select:none; z-index:1200;
    transition:transform .3s; border-radius:12px;
    background: var(--panel); border:1px solid var(--line); box-shadow: var(--shadow-md);
  }
  .hamburger .bar{
    display:block; width:24px; height:2px; background:var(--ink);
    border-radius:10px; transition:transform .35s,opacity .25s,width .35s
  }
  #menu-check:checked+label.hamburger{ transform:translateX(calc(var(--nav-w) - 10px)); }
  #menu-check:checked+label.hamburger .bar:nth-child(1){ transform:translateY(6px) rotate(45deg); width:24px }
  #menu-check:checked+label.hamburger .bar:nth-child(2){ opacity:0 }
  #menu-check:checked+label.hamburger .bar:nth-child(3){ transform:translateY(-6px) rotate(-45deg); width:24px }

  .sidebar{
    position:fixed; inset:0 auto 0 0; width:var(--nav-w);
    background: var(--panel); color: var(--ink);
    padding:18px; box-sizing:border-box;
    transform:translateX(-100%); transition:.3s; z-index:1100; overflow:auto;
    box-shadow: var(--shadow-lg); border-right:1px solid var(--line)
  }
  .sidebar h3{ font-size:12px; letter-spacing:.1em; text-transform:uppercase; color:var(--muted); margin:6px 0 10px }
  .sidebar a,.sidebar button{
    display:block; width:100%; margin-bottom:10px; padding:12px 14px; text-align:left;
    border-radius:10px; text-decoration:none; color:inherit;
    border:1px solid var(--line); background: #0F172A;
  }
  .sidebar a:hover{ border-color:var(--accent); box-shadow: var(--ring); }
  #menu-check:checked~.sidebar{ transform:translateX(0) }

  label.overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.5);
    opacity:0; visibility:hidden; transition:.3s; z-index:1090
  }
  #menu-check:checked~label.overlay{ opacity:1; visibility:visible }

  /* Fancy input (dark restyle) */
  .input-container{ position:relative; margin:8px 4px }
  .input{
    width:100%; padding:12px 12px 12px 14px; height:44px;
    border:1px solid var(--ctrl-border);
    background:var(--ctrl-bg); color:var(--ink);
    font-size:16px; outline:none; border-radius:10px; box-shadow:none;
  }
  .label{
    position:absolute; top:12px; left:14px; color:var(--muted);
    transition:.25s; background:transparent; padding:0 4px; pointer-events:none;
  }
  .topline,.underline{display:none} /* simplified for dark theme clarity */

  .input:focus + .topline, .input:focus + .underline{ display:none }
  .input:focus ~ .label,
  .input:not(:placeholder-shown) ~ .label,
  select.input:focus ~ .label{
    top:-9px; transform:scale(.9);
    background:var(--bg); color:var(--accent);
  }

  /* Add-row layout */
  .add-row{
    display:grid;
    grid-template-columns:minmax(240px,1.4fr) 140px minmax(220px,1fr) auto;
    gap:12px; align-items:center; max-width:900px
  }
  .add-row > *:not(button){ margin:0 } /* grid already controls spacing */
  .add-row button{ min-height:44px }

  /* Helper card (dark cyan) */
  .helper-row{ display:grid; grid-template-columns:1fr; gap:16px; margin-top:12px }
  .card.helper{
    width:100%; border-radius:16px; box-shadow: var(--shadow-lg);
    background: var(--panel); color: var(--ink); padding:16px; border:1px solid var(--line);
  }
  .card-border-top{ width:60%; height:3px; background:var(--accent); margin:6px auto 10px; border-radius:0 0 15px 15px }
  .card.helper .img{
    width:70px; height:70px; background:#0B1323; border:1px solid var(--line);
    border-radius:14px; margin:14px auto 6px; display:flex; align-items:center; justify-content:center; font-size:24px
  }
  .card.helper span{ display:block; text-align:center }
  .card.helper .job{ font-size:12px; color: var(--muted) }
  .card.helper button{
    padding:12px 16px; display:block; margin:12px auto 6px; border-radius:10px;
    border:1px solid var(--accent); background:var(--accent); color:var(--accent-ink); font-weight:700; cursor:pointer
  }
  .card.helper button:hover{ filter:brightness(.96); box-shadow: 0 8px 30px color-mix(in oklab, var(--accent) 25%, transparent) }
  .helper-note{ text-align:center; font-size:12px; color: var(--muted); margin-top:4px }

  /* Toasts */
  .toast-wrap{ position:fixed; right:16px; bottom:16px; display:flex; flex-direction:column; gap:8px; z-index:10000 }
  .toast{
    background: var(--panel); color: var(--ink); padding:10px 12px; border-radius:10px;
    box-shadow: var(--shadow-lg); max-width:86vw; border:1px solid var(--line)
  }
  .toast--warn{ background: color-mix(in oklab, var(--warn) 40%, var(--panel)); border-color: color-mix(in oklab, var(--warn) 60%, var(--line)) }
  .toast--error{ background: color-mix(in oklab, var(--error) 40%, var(--panel)); border-color: color-mix(in oklab, var(--error) 60%, var(--line)) }
  .toast__close{ margin-left:12px; cursor:pointer; font-weight:700 }

  /* Signed-in line */
  .muted{ color:var(--muted); font-size:12px; margin-top:10px }

  /* Mobile tweaks */
  @media (max-width: 820px){
    .add-row{
      grid-template-columns:1fr;
    }
    .hamburger{ transform: none !important } /* keep fixed */
  }

  /* Motion-reduced */
  @media (prefers-reduced-motion: reduce){
    *{ transition:none !important; animation:none !important }
  }
</style>
</head>
<body>

<!-- Toggle checkbox + hamburger -->
<input id="menu-check" type="checkbox" />
<label for="menu-check" class="hamburger" aria-label="Toggle menu" aria-controls="side" role="button" tabindex="0">
  <span class="bar"></span><span class="bar"></span><span class="bar"></span>
</label>

<!-- Off-canvas sidebar -->
<nav class="sidebar" id="side" role="navigation" aria-label="Main">
  <h3>Inventory</h3>
  <a href="index.html">Add New Stock</a>
  <a href="adjust.html">Adjust Stock</a>
  <a href="location.html">Location</a>
  <a href="goal.html">Set Stock Count Goal</a>
  <a href="history.html">History</a>
  <a href="status.html">Status</a>
  <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
  <button onclick="logout()">Logout</button>

  <h3>Accent</h3>
  <div style="display:flex; gap:8px">
    <button type="button" class="btn-accent" onclick="setAccent('cyan')" title="Cyan">Cyan</button>
    <button type="button" class="btn-accent" onclick="setAccent('neon')" title="Neon">Neon</button>
  </div>
</nav>

<!-- Click-away overlay -->
<label class="overlay" for="menu-check" aria-hidden="true"></label>

<!-- Toast container -->
<div class="toast-wrap" id="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<main class="content">
  <section aria-labelledby="addPageTitle">
    <h2 id="addPageTitle">Add New Item</h2>

    <div class="add-row">
      <div class="input-container">
        <input type="text" id="newItemName" class="input" placeholder=" " autocomplete="off" />
        <span class="topline"></span><span class="underline"></span>
        <label for="newItemName" class="label">Item Name</label>
      </div>

      <input type="number" id="newItemQty" placeholder="Quantity" min="1" inputmode="numeric" aria-label="Quantity" />

      <div class="input-container">
        <select id="newItemLoc" class="input" style="height:44px">
          <option>Old warehouse</option>
          <option>New warehouse</option>
          <option>Office</option>
        </select>
        <span class="topline"></span><span class="underline"></span>
        <label for="newItemLoc" class="label">Location</label>
      </div>

      <button class="btn-accent" onclick="addNewItem()" aria-label="Add Item">Add Item</button>
    </div>

    <div class="helper-row">
      <div class="card helper" aria-label="Image Helper">
        <div class="card-border-top"></div>
        <div class="img">🖼️</div>
        <span>Need an image URL?</span>
        <span class="job">Upload to ImageKit, copy the link, then set it via the 🖼 button on an item.</span>
        <button type="button" class="btn-accent" onclick="openImgbb()">Open ImageKit</button>
        <div class="helper-note">Tip: choose “Direct link” if available.</div>
      </div>
    </div>

    <div class="muted">Signed in as <strong id="signedAs"></strong>. Data syncs via Firebase (Firestore + Storage).</div>
  </section>
</main>

<!-- Firebase + App Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
    authDomain: "epedu-inventory-database.firebaseapp.com",
    projectId: "epedu-inventory-database",
    storageBucket: "epedu-inventory-database.appspot.com",
    messagingSenderId: "124437251040",
    appId: "1:124437251040:web:4989c73efc2f4afbf22185",
    measurementId: "G-GFEEP49VRP"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) {}
  const auth = getAuth(app);
  const db   = getFirestore(app);
  signInAnonymously(auth).catch(console.error);

  const CURRENT_USER = localStorage.getItem('auth_user') || 'Unknown';
  const signedAs = document.getElementById('signedAs'); if (signedAs) signedAs.textContent = CURRENT_USER;

  /* Accent toggle persistence */
  const ACCENT_KEY = 'ui_accent';
  const savedAccent = localStorage.getItem(ACCENT_KEY);
  if (savedAccent) document.documentElement.setAttribute('data-accent', savedAccent);
  window.setAccent = (name) => {
    const val = (name === 'neon') ? 'neon' : 'cyan';
    document.documentElement.setAttribute('data-accent', val);
    localStorage.setItem(ACCENT_KEY, val);
  };

  /* Toasts */
  const toastWrap = document.getElementById('toast-wrap');
  function toast(msg, type='info', timeout=3200){
    const el = document.createElement('div');
    el.className = 'toast' + (type==='warn' ? ' toast--warn' : type==='error' ? ' toast--error' : '');
    el.innerHTML = `${escapeHtml(msg)} <span class="toast__close" aria-label="Dismiss" role="button">×</span>`;
    toastWrap.appendChild(el);
    const close = ()=>{ if (el && el.parentNode) el.parentNode.removeChild(el); };
    el.querySelector('.toast__close').addEventListener('click', close);
    if (timeout>0) setTimeout(close, timeout);
  }
  const notify = toast;

  /* Utils */
  function escapeHtml(s){ return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function normLoc(raw){
    const s=(raw||'').trim().toLowerCase();
    if (s.startsWith('old')) return 'Old warehouse';
    if (s.startsWith('new')) return 'New warehouse';
    if (s.startsWith('off')) return 'Office';
    if (['old warehouse','new warehouse','office'].includes(s)) return s.replace(/\b\w/g,m=>m.toUpperCase());
    return null;
  }

  /* Sidebar ARIA */
  const menuCheck = document.getElementById('menu-check');
  const hamb = document.querySelector('label.hamburger');
  function syncAria(){ hamb.setAttribute('aria-expanded', String(menuCheck.checked)); }
  menuCheck.addEventListener('change', syncAria); syncAria();

  /* Firestore refs */
  const colInventory = collection(db, "inventory");

  /* Keep a local copy of inventory so addNewItem can merge quantities if item exists */
  let inventory = [];
  onSnapshot(colInventory, (snap) => { inventory = snap.docs.map(d => ({ id:d.id, ...d.data() })); });

  /* Open ImageKit instead of imgbb */
  window.openImgbb = () => window.open('https://imagekit.io/dashboard/media-library/L0VQRURVIElOVkVOVE9SWSA', '_blank', 'noopener');

  /* Add item (now supports Office) */
  async function addNewItem() {
    const name = (document.getElementById('newItemName').value || '').trim().replace(/\s+/g,' ');
    const qty  = parseInt(document.getElementById('newItemQty').value,10);
    const location = normLoc(document.getElementById('newItemLoc').value);
    if (!name || isNaN(qty) || qty <= 0) { notify("Enter a valid name and a quantity ≥ 1","warn"); return; }
    if (!location) { notify('Location must be "Old warehouse", "New warehouse", or "Office".',"warn"); return; }

    const existing = inventory.find(i => (i.name||'').toLowerCase() === name.toLowerCase());
    try{
      if (existing) {
        const incOld    = location === 'Old warehouse' ? qty : 0;
        const incNew    = location === 'New warehouse' ? qty : 0;
        const incOffice = location === 'Office'         ? qty : 0;
        const newOld    = Math.max(0, (existing.qtyOld ?? 0)    + incOld);
        const newNew    = Math.max(0, (existing.qtyNew ?? 0)    + incNew);
        const newOffice = Math.max(0, (existing.qtyOffice ?? 0) + incOffice);
        await updateDoc(doc(db, "inventory", existing.id), {
          qtyOld: newOld, qtyNew: newNew, qtyOffice: newOffice, qty: newOld + newNew + newOffice, isNew:true
        });
      } else {
        const qtyOld    = location === 'Old warehouse' ? qty : 0;
        const qtyNew    = location === 'New warehouse' ? qty : 0;
        const qtyOffice = location === 'Office'         ? qty : 0;
        await addDoc(colInventory, {
          name, qtyOld, qtyNew, qtyOffice, qty: qtyOld + qtyNew + qtyOffice, goal:0, img:null, isNew:true, createdAt: serverTimestamp()
        });
      }
      notify(`Item "${name}" added to ${location}.`);
    } catch(err){ console.error(err); notify('Failed to add item','error'); }
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemQty').value = '';
  }
  window.addNewItem = addNewItem;
</script>
</body>
</html>
