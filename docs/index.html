<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory System ‚Äî Add New Stock</title>

<!-- Auth gate with role check (GitHub Pages‚Äìsafe redirects) -->
<script>
  function ghBase(file) {
    // If hosted on GitHub Pages project site, prefix with "/REPO/"
    if (location.hostname.endsWith('github.io')) {
      const parts = location.pathname.split('/').filter(Boolean);
      const repo = parts.length > 0 ? parts[0] : '';
      return (repo ? `/${repo}/` : '/') + file;
    }
    return file; // local dev or custom domain
  }

  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role'); // 'admin' | 'editor' | 'viewer'

  if (!AUTH_OK || !AUTH_USER) {
    window.location.replace(ghBase('login.html'));
  } else if (AUTH_ROLE === 'viewer') {
    window.location.replace(ghBase('viewer.html'));
  }

  function logout(){
    localStorage.removeItem('auth_v1');
    localStorage.removeItem('auth_user');
    localStorage.removeItem('auth_role');
    localStorage.removeItem('auth_time');
    window.location.replace(ghBase('login.html'));
  }
  window.logout = logout; // used by sidebar button
</script>

<style>
  /* ==== Light theme based on #F7F4EA ==== */
  :root{
    --nav-w:260px;

    /* Theme */
    --bg:#F7F4EA;        /* paper background */
    --panel:#EEE6D8;     /* cards / panels */
    --ink:#1F2937;       /* primary text */
    --muted:#6B7280;     /* muted text */
    --line:#D9CFC1;      /* borders/outlines */
    --accent:#0EA5A4;    /* teal accent */
    --chip:#EDE7DA;      /* subtle chip/pill bg */

    /* Helper card accents */
    --helper-accent:#6D28D9;  /* purple accent line (kept as a fun pop) */
    --helper-panel:#F3ECDF;   /* light panel inside helper */
  }

  html,body{height:100%}
  body{
    margin:0;
    font-family:Arial,sans-serif;
    background:var(--bg);
    color:var(--ink)
  }
  h1,h2,h3{color:var(--ink)}
  .content{padding:20px;padding-top:80px;min-height:100vh;box-sizing:border-box}

  /* Controls ‚Äî legibility & theme consistency */
  input,button,select,textarea{
    padding:8px;margin:4px;font-family:inherit;
    color:var(--ink);
    background:var(--panel);
    border:1px solid var(--line);
    caret-color:var(--ink);
  }
  input::placeholder, textarea::placeholder{ color:var(--muted); opacity:1 }

  button{
    border-radius:8px;
    cursor:pointer;
    transition:.15s ease;
  }
  button:hover{
    background:var(--accent);
    color:#ffffff;
    border-color:var(--accent);
  }

  .muted{color:var(--muted);font-size:12px;margin-top:6px}

  /* Sidebar + hamburger */
  #menu-check{display:none}
  .hamburger{
    position:fixed;left:12px;top:12px;width:32px;display:flex;flex-direction:column;gap:7px;
    cursor:pointer;user-select:none;z-index:1200;transition:transform .3s
  }
  .hamburger .bar{
    height:3px;background:var(--ink);border-radius:10px;
    transition:transform .35s,opacity .25s,width .35s
  }
  .hamburger .bar1,.hamburger .bar3{width:18px}.hamburger .bar2{width:28px}
  #menu-check:checked+label.hamburger{transform:translateX(var(--nav-w))}
  #menu-check:checked+label.hamburger .bar1{transform:translateY(10px) rotate(45deg);width:28px}
  #menu-check:checked+label.hamburger .bar2{opacity:0}
  #menu-check:checked+label.hamburger .bar3{transform:translateY(-10px) rotate(-45deg);width:28px}

  .sidebar{
    position:fixed;inset:0 auto 0 0;width:var(--nav-w);
    background:var(--panel);padding:20px;box-sizing:border-box;
    transform:translateX(-100%);transition:.3s;z-index:1100;overflow:auto;
    box-shadow:0 10px 30px rgba(0,0,0,.08);border-right:1px solid var(--line)
  }
  .sidebar a,.sidebar button{
    display:block;width:100%;margin-bottom:10px;padding:10px;text-align:left;border-radius:8px;text-decoration:none;
    color:inherit;border:1px solid var(--line);background:transparent
  }
  .sidebar a:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  #menu-check:checked~.sidebar{transform:translateX(0)}
  label.overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;visibility:hidden;transition:.3s;z-index:1090}
  #menu-check:checked~label.overlay{opacity:1;visibility:visible}

  /* Fancy input (uses theme vars) */
  .input-container{position:relative;margin:8px 4px}
  .input{
    width:100%;padding:10px;height:40px;
    border:2px solid var(--line);
    border-top:none;border-bottom:none;
    font-size:16px;background:transparent;outline:none;
    box-shadow:7px 7px 0 0 var(--line);
    transition:.5s;box-sizing:border-box;
    color:var(--ink);caret-color:var(--ink);
  }
  .label{
    position:absolute;top:10px;left:10px;color:var(--ink);
    transition:.5s;transform:scale(0);z-index:-1;background:var(--bg);padding:0 4px
  }
  .topline,.underline{position:absolute;background-color:var(--line);height:2px;right:0;transition:.5s}
  .topline{width:0}.underline{width:0;bottom:0}
  .input-container input:focus~.topline{width:35%}
  .input-container input:focus~.underline{width:100%}
  .input-container input:focus~.label{top:-10px;transform:scale(1)}
  .input-container select{appearance:none}

  /* Helper card (themed) */
  .helper-row{display:grid;grid-template-columns:1fr;gap:16px;margin-top:12px}
  @media (min-width: 600px) {
    .helper-row{grid-template-columns:1fr 1fr}
  }
  @media (min-width: 900px) {
    .helper-row{grid-template-columns:1fr 1fr 1fr 1fr}
  }
  .card.helper{
    width:100%;border-radius:15px;background:var(--helper-panel);color:var(--ink);padding:16px;
    box-shadow:0 8px 22px rgba(0,0,0,.08);border:1px solid var(--line)
  }
  .card-border-top{width:60%;height:3px;background:var(--helper-accent);margin:6px auto 10px;border-radius:0 0 15px 15px}
  .card.helper .img{
    width:70px;height:70px;background:var(--panel);border-radius:15px;margin:14px auto 6px;
    display:flex;align-items:center;justify-content:center;font-size:24px;border:1px solid var(--line)
  }
  .card.helper span{display:block;text-align:center}
  .card.helper .job{font-size:12px;color:var(--muted)}
  .card.helper button{
    padding:10px 16px;display:block;margin:12px auto 6px;border-radius:8px;border:1px solid var(--accent);
    background:var(--accent);color:#fff;font-weight:600;cursor:pointer
  }
  .card.helper button:hover{filter:brightness(.95)}
  .helper-note{text-align:center;font-size:12px;color:var(--muted);margin-top:4px}

  /* Barcode Scanner Buttons */
  .scanner-btn{
    background:var(--helper-accent);
    border-color:var(--helper-accent);
    color:#fff;
    font-size:14px;
    font-weight:600;
    padding:10px 16px;
    min-width:80px;
    white-space:nowrap;
  }
  .scanner-btn:hover{
    filter:brightness(.9);
    color:#fff;
  }
  .scanner-btn.secondary{
    background:#0EA5A4;
    border-color:#0EA5A4;
  }
  .scanner-btn.secondary:hover{
    color:#fff;
  }

  /* Scanner Modal */
  .scanner-modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.85);
    z-index:2000;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .scanner-modal.active{display:flex}
  .scanner-content{
    background:var(--panel);
    border-radius:12px;
    padding:20px;
    max-width:600px;
    width:100%;
    box-shadow:0 20px 60px rgba(0,0,0,.3);
  }
  .scanner-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
  }
  .scanner-header h3{margin:0}
  .scanner-close{
    background:transparent;
    border:none;
    font-size:28px;
    cursor:pointer;
    padding:0;
    width:32px;
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--ink);
  }
  .scanner-close:hover{
    background:var(--line);
    border-radius:50%;
  }
  #reader, #quickReader{
    border:2px solid var(--line);
    border-radius:8px;
    overflow:hidden;
    background:#000;
  }
  .scanner-result{
    margin-top:12px;
    padding:12px;
    background:var(--bg);
    border-radius:8px;
    border:1px solid var(--accent);
    display:none;
  }
  .scanner-result.active{display:block}
  .scanner-result strong{color:var(--accent)}

  /* Product Selection Modal */
  .product-modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.85);
    z-index:2100;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .product-modal.active{display:flex}
  .product-content{
    background:var(--panel);
    border-radius:12px;
    padding:24px;
    max-width:500px;
    width:100%;
    box-shadow:0 20px 60px rgba(0,0,0,.3);
  }
  .product-header{
    margin-bottom:20px;
  }
  .product-header h3{margin:0 0 8px 0}
  .serial-display{
    background:var(--bg);
    padding:12px;
    border-radius:8px;
    border:2px solid var(--accent);
    margin-bottom:16px;
    text-align:center;
  }
  .serial-display .serial-label{
    font-size:12px;
    color:var(--muted);
    margin-bottom:4px;
  }
  .serial-display .serial-number{
    font-size:20px;
    font-weight:bold;
    color:var(--accent);
    font-family:monospace;
  }
  .product-list{
    max-height:300px;
    overflow-y:auto;
    margin-bottom:16px;
  }
  .product-item{
    padding:12px;
    margin-bottom:8px;
    background:var(--bg);
    border:2px solid var(--line);
    border-radius:8px;
    cursor:pointer;
    transition:.2s ease;
  }
  .product-item:hover{
    border-color:var(--accent);
    background:var(--chip);
  }
  .product-item.selected{
    border-color:var(--accent);
    background:var(--chip);
  }
  .product-name{
    font-weight:600;
    margin-bottom:4px;
  }
  .product-info{
    font-size:12px;
    color:var(--muted);
  }
  .product-actions{
    display:flex;
    gap:12px;
  }
  .product-actions button{
    flex:1;
    padding:12px;
  }
  .btn-cancel{
    background:transparent;
    border:2px solid var(--line);
  }
  .btn-cancel:hover{
    background:var(--line);
    color:var(--ink);
  }
  .btn-confirm{
    background:var(--accent);
    border:2px solid var(--accent);
    color:#fff;
  }
  .btn-confirm:hover{
    filter:brightness(.9);
  }
  .btn-confirm:disabled{
    opacity:.5;
    cursor:not-allowed;
  }

  /* Quick Scan Modal */
  .quick-scan-modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.85);
    z-index:2100;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .quick-scan-modal.active{display:flex}
  .quick-scan-content{
    background:var(--panel);
    border-radius:12px;
    padding:24px;
    max-width:500px;
    width:100%;
    box-shadow:0 20px 60px rgba(0,0,0,.3);
  }
  .quick-scan-header{
    margin-bottom:20px;
    text-align:center;
  }
  .quick-scan-header h3{margin:0 0 12px 0}
  .product-found{
    background:var(--bg);
    padding:16px;
    border-radius:8px;
    border:2px solid var(--accent);
    margin-bottom:16px;
    text-align:center;
  }
  .product-found .found-label{
    font-size:12px;
    color:var(--muted);
    margin-bottom:4px;
  }
  .product-found .found-name{
    font-size:22px;
    font-weight:bold;
    color:var(--accent);
    margin-bottom:8px;
  }
  .product-found .found-barcode{
    font-size:14px;
    color:var(--muted);
    font-family:monospace;
  }
  .quick-controls{
    display:grid;
    gap:12px;
    margin-bottom:16px;
  }
  .control-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    align-items:center;
  }
  .qty-control{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .qty-btn{
    width:40px;
    height:40px;
    font-size:20px;
    font-weight:bold;
    padding:0;
    border-radius:8px;
  }
  .qty-display{
    flex:1;
    text-align:center;
    font-size:24px;
    font-weight:bold;
    padding:8px;
    background:var(--bg);
    border-radius:8px;
    border:2px solid var(--line);
  }
  .action-toggle{
    display:flex;
    gap:8px;
  }
  .action-toggle button{
    flex:1;
    padding:12px;
    font-weight:600;
  }
  .action-toggle button.active{
    background:var(--accent);
    border-color:var(--accent);
    color:#fff;
  }

  /* Barcode List Items */
  .barcode-group{
    margin-bottom:16px;
    background:var(--bg);
    border-radius:8px;
    padding:12px;
    border:1px solid var(--line);
  }
  .barcode-group-header{
    font-weight:600;
    font-size:16px;
    color:var(--ink);
    margin-bottom:8px;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .barcode-count{
    font-size:12px;
    color:var(--muted);
    font-weight:normal;
  }
  .barcode-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px;
    background:var(--panel);
    border-radius:6px;
    margin-bottom:6px;
    border:1px solid var(--line);
  }
  .barcode-item:last-child{margin-bottom:0}
  .barcode-code{
    font-family:monospace;
    font-size:14px;
    color:var(--accent);
    font-weight:600;
  }
  .barcode-remove{
    padding:6px 12px;
    font-size:12px;
    background:transparent;
    border:1px solid #E74C3C;
    color:#E74C3C;
    border-radius:6px;
    cursor:pointer;
    transition:.2s;
  }
  .barcode-remove:hover{
    background:#E74C3C;
    color:#fff;
  }
  .no-barcodes{
    text-align:center;
    padding:40px 20px;
    color:var(--muted);
    font-size:14px;
  }

  /* Toasts */
  .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
  .toast{
    background:#E9E2D6;color:var(--ink);padding:10px 12px;border-radius:8px;
    box-shadow:0 10px 30px rgba(0,0,0,.12);max-width:86vw
  }
  .toast--warn{background:#F2C97D;color:#4A2E00}.toast--error{background:#F3B8B8;color:#711313}
  .toast__close{margin-left:12px;cursor:pointer;font-weight:700}
</style>
</head>
<body>

<!-- Toggle checkbox + hamburger -->
<input id="menu-check" type="checkbox" />
<label for="menu-check" class="hamburger" aria-label="Toggle menu" aria-controls="side" role="button" tabindex="0">
  <span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span>
</label>

<!-- Off-canvas sidebar -->
<nav class="sidebar" id="side" role="navigation" aria-label="Main">
  <a href="index.html">Add New Stock</a>
  <a href="adjust.html">Adjust Stock</a>
  <a href="location.html">Location</a>
  <a href="goal.html">Set Stock Count Goal</a>
  <a href="history.html">History</a>
  <a href="status.html">Status</a>
  <a href="loan.html">Loan</a>
  <hr>
  <button onclick="logout()">Logout</button>
</nav>

<!-- Click-away overlay -->
<label class="overlay" for="menu-check" aria-hidden="true"></label>

<!-- Toast container -->
<div class="toast-wrap" id="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<!-- Register Barcode Scanner Modal -->
<div class="scanner-modal" id="registerScannerModal">
  <div class="scanner-content">
    <div class="scanner-header">
      <h3>Register Barcode to Product</h3>
      <button class="scanner-close" onclick="closeRegisterScanner()" aria-label="Close scanner">√ó</button>
    </div>
    <div id="reader"></div>
    <div class="scanner-result" id="registerScannerResult">
      <strong>Scanned:</strong> <span id="registerScannedCode"></span>
    </div>
  </div>
</div>

<!-- Product Selection Modal (for registering barcode) -->
<div class="product-modal" id="productModal">
  <div class="product-content">
    <div class="product-header">
      <h3>Select Product for Barcode</h3>
      <div class="serial-display">
        <div class="serial-label">Barcode Number</div>
        <div class="serial-number" id="modalBarcodeNumber">‚Äî</div>
      </div>
    </div>
    <div class="product-list" id="productList">
      <!-- Products will be populated here -->
    </div>
    <div class="product-actions">
      <button class="btn-cancel" onclick="closeProductModal()">Cancel</button>
      <button class="btn-confirm" id="confirmProductBtn" onclick="confirmProductBarcode()" disabled>Register</button>
    </div>
  </div>
</div>

<!-- Quick Scan Scanner Modal -->
<div class="scanner-modal" id="quickScannerModal">
  <div class="scanner-content">
    <div class="scanner-header">
      <h3>Quick Scan - Add/Subtract Stock</h3>
      <button class="scanner-close" onclick="closeQuickScanner()" aria-label="Close scanner">√ó</button>
    </div>
    <div id="quickReader"></div>
    <div class="scanner-result" id="quickScannerResult">
      <strong>Scanned:</strong> <span id="quickScannedCode"></span>
    </div>
  </div>
</div>

<!-- Quick Scan Action Modal -->
<div class="quick-scan-modal" id="quickActionModal">
  <div class="quick-scan-content">
    <div class="quick-scan-header">
      <h3>Adjust Stock</h3>
      <div class="product-found" id="productFound">
        <div class="found-label">Product</div>
        <div class="found-name" id="foundProductName">‚Äî</div>
        <div class="found-barcode" id="foundBarcode">‚Äî</div>
      </div>
    </div>
    
    <div class="quick-controls">
      <div class="control-row">
        <label style="font-weight:600">Action:</label>
        <div class="action-toggle">
          <button id="addBtn" class="active" onclick="setAction('add')">Add</button>
          <button id="subtractBtn" onclick="setAction('subtract')">Subtract</button>
        </div>
      </div>
      
      <div class="control-row" style="grid-template-columns:1fr">
        <label style="font-weight:600">Quantity:</label>
        <div class="qty-control">
          <button class="qty-btn" onclick="changeQty(-1)">‚àí</button>
          <div class="qty-display" id="qtyDisplay">1</div>
          <button class="qty-btn" onclick="changeQty(1)">+</button>
        </div>
      </div>
      
      <div class="control-row" style="grid-template-columns:1fr">
        <label style="font-weight:600">Location:</label>
        <select id="quickLocation" style="width:100%;height:44px;padding:10px">
          <option>Old warehouse</option>
          <option>New warehouse</option>
          <option>Office</option>
        </select>
      </div>
    </div>
    
    <div class="product-actions">
      <button class="btn-cancel" onclick="closeQuickActionModal()">Cancel</button>
      <button class="btn-confirm" onclick="executeQuickAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- View Barcodes Modal -->
<div class="product-modal" id="viewBarcodesModal" style="z-index:2200">
  <div class="product-content" style="max-width:700px">
    <div class="product-header">
      <h3>Barcode Assignments</h3>
      <p style="font-size:14px;color:var(--muted);margin:8px 0 0 0">View and manage barcode-to-product assignments</p>
    </div>
    <div id="barcodesList" style="max-height:400px;overflow-y:auto;margin-bottom:16px">
      <!-- Barcodes will be populated here -->
    </div>
    <div class="product-actions">
      <button class="btn-confirm" style="flex:none;width:100%" onclick="closeViewBarcodesModal()">Close</button>
    </div>
  </div>
</div>

<main class="content">
  <section aria-labelledby="addPageTitle">
    <h2 id="addPageTitle">Add New Item</h2>
    <div class="add-row" style="display:grid;grid-template-columns:minmax(260px,1fr) 160px minmax(220px,1fr) auto;gap:12px;align-items:center;max-width:900px">
      <div class="input-container">
        <input type="text" id="newItemName" class="input" placeholder=" " autocomplete="off" />
        <span class="topline"></span><span class="underline"></span>
        <label for="newItemName" class="label">Item Name</label>
      </div>
      <input type="number" id="newItemQty" placeholder="Quantity" min="1" inputmode="numeric" aria-label="Quantity" />
      <div class="input-container">
        <select id="newItemLoc" class="input" style="height:40px">
          <option>Old warehouse</option>
          <option>New warehouse</option>
          <option>Office</option>
        </select>
        <span class="topline"></span><span class="underline"></span>
        <label for="newItemLoc" class="label">Location</label>
      </div>
      <button onclick="addNewItem()" aria-label="Add Item">Add Item</button>
    </div>

    <div class="helper-row">
      <div class="card helper" aria-label="Register Barcode Helper">
        <div class="card-border-top"></div>
        <div class="img">üîñ</div>
        <span>Register Barcode</span>
        <span class="job">Scan a barcode and assign it to a product (e.g., one barcode for mBot2, another for AI Camera). Use this to set up product barcodes.</span>
        <button type="button" onclick="openRegisterScanner()">Register Barcode</button>
        <div class="helper-note">Tip: Each product can have multiple barcodes.</div>
      </div>
      
      <div class="card helper" aria-label="Quick Scan Helper">
        <div class="card-border-top"></div>
        <div class="img">‚ö°</div>
        <span>Quick Scan Stock</span>
        <span class="job">Scan a registered barcode to quickly add or subtract stock. Choose quantity, action (add/subtract), and location. Perfect for fast inventory updates!</span>
        <button type="button" onclick="openQuickScanner()">Quick Scan</button>
        <div class="helper-note">Tip: Barcode must be registered first.</div>
      </div>
      
      <div class="card helper" aria-label="Image Helper">
        <div class="card-border-top"></div>
        <div class="img">üñºÔ∏è</div>
        <span>Need an image URL?</span>
        <span class="job">Upload to ImageKit, copy the link, then set it via the üñº button on an item.</span>
        <button type="button" onclick="openImgbb()">Open ImageKit</button>
        <div class="helper-note">Tip: choose "Direct link" if available.</div>
      </div>
      
      <div class="card helper" aria-label="View Barcodes Helper">
        <div class="card-border-top"></div>
        <div class="img">üìã</div>
        <span>View Barcode Assignments</span>
        <span class="job">See all registered barcodes and which products they're assigned to. Remove barcodes you no longer need.</span>
        <button type="button" onclick="openViewBarcodesModal()">View Barcodes</button>
        <div class="helper-note">Tip: Manage all barcode assignments in one place.</div>
      </div>
    </div>

    <div class="muted">Signed in as <strong id="signedAs"></strong>. Data syncs via Firebase (Firestore + Storage).</div>
  </section>
</main>

<!-- HTML5 QR Code Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- Firebase + App Logic -->
<script type="module">
  // Global error handler to prevent blank pages
  window.addEventListener('error', function(e) {
    console.error('Global error caught:', e.error);
    // Don't let errors break the page
    e.preventDefault();
  });

  window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
    e.preventDefault();
  });

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
    authDomain: "epedu-inventory-database.firebaseapp.com",
    projectId: "epedu-inventory-database",
    storageBucket: "epedu-inventory-database.appspot.com",
    messagingSenderId: "124437251040",
    appId: "1:124437251040:web:4989c73efc2f4afbf22185",
    measurementId: "G-GFEEP49VRP"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) {}
  const auth = getAuth(app);
  const db   = getFirestore(app);
  signInAnonymously(auth).catch(console.error);

  const CURRENT_USER = localStorage.getItem('auth_user') || 'Unknown';
  const signedAs = document.getElementById('signedAs'); if (signedAs) signedAs.textContent = CURRENT_USER;

  /* Toasts */
  const toastWrap = document.getElementById('toast-wrap');
  function toast(msg, type='info', timeout=3200){
    const el = document.createElement('div');
    el.className = 'toast' + (type==='warn' ? ' toast--warn' : type==='error' ? ' toast--error' : '');
    el.innerHTML = `${escapeHtml(msg)} <span class="toast__close" aria-label="Dismiss" role="button">√ó</span>`;
    toastWrap.appendChild(el);
    const close = ()=>{ if (el && el.parentNode) el.parentNode.removeChild(el); };
    el.querySelector('.toast__close').addEventListener('click', close);
    if (timeout>0) setTimeout(close, timeout);
  }
  const notify = toast;

  /* Utils */
  function escapeHtml(s){ return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function normLoc(raw){
    const s=(raw||'').trim().toLowerCase();
    if (s.startsWith('old')) return 'Old warehouse';
    if (s.startsWith('new')) return 'New warehouse';
    if (s.startsWith('off')) return 'Office';
    if (['old warehouse','new warehouse','office'].includes(s)) return s.replace(/\b\w/g,m=>m.toUpperCase());
    return null;
  }

  /* Sidebar ARIA */
  const menuCheck = document.getElementById('menu-check');
  const hamb = document.querySelector('label.hamburger');
  function syncAria(){ hamb.setAttribute('aria-expanded', String(menuCheck.checked)); }
  menuCheck.addEventListener('change', syncAria); syncAria();

  /* Firestore refs */
  const colInventory = collection(db, "inventory");

  /* Keep a local copy of inventory */
  let inventory = [];
  onSnapshot(colInventory, (snap) => { inventory = snap.docs.map(d => ({ id:d.id, ...d.data() })); });

  /* Open ImageKit */
  window.openImgbb = () => window.open('https://imagekit.io/dashboard/media-library/L0VQRURVIElOVkVOVE9SWSA', '_blank', 'noopener');

  /* ============================================ */
  /* FUNCTION 1: REGISTER BARCODE TO PRODUCT     */
  /* ============================================ */
  
  let registerHtml5QrCode = null;
  let registerScannerActive = false;
  let scannedBarcode = null;
  let selectedProductId = null;

  window.openRegisterScanner = async function() {
    const modal = document.getElementById('registerScannerModal');
    const resultDiv = document.getElementById('registerScannerResult');
    
    modal.classList.add('active');
    resultDiv.classList.remove('active');
    
    if (!registerHtml5QrCode) {
      registerHtml5QrCode = new Html5Qrcode("reader");
    }

    if (registerScannerActive) return;

    try {
      await registerHtml5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
        (decodedText, decodedResult) => {
          document.getElementById('registerScannedCode').textContent = decodedText;
          document.getElementById('registerScannerResult').classList.add('active');
          scannedBarcode = decodedText;
          notify(`Barcode scanned: ${decodedText}`);
          setTimeout(() => {
            closeRegisterScanner();
            openProductModal(decodedText);
          }, 1500);
        },
        (errorMessage) => {}
      );
      registerScannerActive = true;
    } catch (err) {
      console.error("Unable to start scanner:", err);
      notify("Unable to access camera. Please check permissions.", "error");
      modal.classList.remove('active');
    }
  };

  window.closeRegisterScanner = async function() {
    if (registerHtml5QrCode && registerScannerActive) {
      try {
        await registerHtml5QrCode.stop();
        registerScannerActive = false;
      } catch (err) {
        console.error("Error stopping scanner:", err);
      }
    }
    document.getElementById('registerScannerModal').classList.remove('active');
    document.getElementById('registerScannerResult').classList.remove('active');
  };

  document.getElementById('registerScannerModal').addEventListener('click', (e) => {
    if (e.target.id === 'registerScannerModal') closeRegisterScanner();
  });

  function openProductModal(barcode) {
    const modal = document.getElementById('productModal');
    const barcodeDisplay = document.getElementById('modalBarcodeNumber');
    const productList = document.getElementById('productList');
    const confirmBtn = document.getElementById('confirmProductBtn');
    
    barcodeDisplay.textContent = barcode;
    selectedProductId = null;
    confirmBtn.disabled = true;
    
    productList.innerHTML = '';
    
    if (inventory.length === 0) {
      productList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">No products available. Add products first.</div>';
    } else {
      inventory.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'product-item';
        itemDiv.dataset.productId = item.id;
        
        const totalQty = (item.qtyOld || 0) + (item.qtyNew || 0) + (item.qtyOffice || 0);
        const barcodeCount = (item.barcodes || []).length;
        
        itemDiv.innerHTML = `
          <div class="product-name">${escapeHtml(item.name)}</div>
          <div class="product-info">Total Qty: ${totalQty} | Barcodes: ${barcodeCount}</div>
        `;
        
        itemDiv.addEventListener('click', () => selectProduct(item.id));
        productList.appendChild(itemDiv);
      });
    }
    
    modal.classList.add('active');
  }

  function selectProduct(productId) {
    selectedProductId = productId;
    document.querySelectorAll('.product-item').forEach(item => {
      item.classList.remove('selected');
    });
    document.querySelector(`[data-product-id="${productId}"]`)?.classList.add('selected');
    document.getElementById('confirmProductBtn').disabled = false;
  }

  window.closeProductModal = function() {
    document.getElementById('productModal').classList.remove('active');
    selectedProductId = null;
    scannedBarcode = null;
  };

  window.confirmProductBarcode = async function() {
    if (!selectedProductId || !scannedBarcode) {
      notify('Please select a product', 'warn');
      return;
    }
    
    try {
      const product = inventory.find(i => i.id === selectedProductId);
      const existingBarcodes = product.barcodes || [];
      
      // Check if barcode already exists for ANY product
      const barcodeExists = inventory.some(item => (item.barcodes || []).includes(scannedBarcode));
      if (barcodeExists) {
        notify('This barcode is already registered to a product', 'warn');
        return;
      }
      
      await updateDoc(doc(db, "inventory", selectedProductId), {
        barcodes: arrayUnion(scannedBarcode)
      });
      
      notify(`Barcode registered to ${product.name}`);
      closeProductModal();
      
    } catch (err) {
      console.error('Error registering barcode:', err);
      notify('Failed to register barcode', 'error');
    }
  };

  document.getElementById('productModal').addEventListener('click', (e) => {
    if (e.target.id === 'productModal') closeProductModal();
  });

  /* ============================================ */
  /* FUNCTION 2: QUICK SCAN ADD/SUBTRACT STOCK   */
  /* ============================================ */

  let quickHtml5QrCode = null;
  let quickScannerActive = false;
  let quickScannedBarcode = null;
  let quickProductId = null;
  let quickQty = 1;
  let quickAction = 'add'; // 'add' or 'subtract'

  window.openQuickScanner = async function() {
    const modal = document.getElementById('quickScannerModal');
    const resultDiv = document.getElementById('quickScannerResult');
    
    modal.classList.add('active');
    resultDiv.classList.remove('active');
    
    if (!quickHtml5QrCode) {
      quickHtml5QrCode = new Html5Qrcode("quickReader");
    }

    if (quickScannerActive) return;

    try {
      await quickHtml5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
        (decodedText, decodedResult) => {
          document.getElementById('quickScannedCode').textContent = decodedText;
          document.getElementById('quickScannerResult').classList.add('active');
          quickScannedBarcode = decodedText;
          
          // Find product with this barcode
          const foundProduct = inventory.find(item => (item.barcodes || []).includes(decodedText));
          
          if (foundProduct) {
            notify(`Product found: ${foundProduct.name}`);
            setTimeout(() => {
              closeQuickScanner();
              openQuickActionModal(foundProduct, decodedText);
            }, 1500);
          } else {
            notify('Barcode not registered. Please register it first.', 'warn');
          }
        },
        (errorMessage) => {}
      );
      quickScannerActive = true;
    } catch (err) {
      console.error("Unable to start quick scanner:", err);
      notify("Unable to access camera. Please check permissions.", "error");
      modal.classList.remove('active');
    }
  };

  window.closeQuickScanner = async function() {
    if (quickHtml5QrCode && quickScannerActive) {
      try {
        await quickHtml5QrCode.stop();
        quickScannerActive = false;
      } catch (err) {
        console.error("Error stopping quick scanner:", err);
      }
    }
    document.getElementById('quickScannerModal').classList.remove('active');
    document.getElementById('quickScannerResult').classList.remove('active');
  };

  document.getElementById('quickScannerModal').addEventListener('click', (e) => {
    if (e.target.id === 'quickScannerModal') closeQuickScanner();
  });

  function openQuickActionModal(product, barcode) {
    quickProductId = product.id;
    quickQty = 1;
    quickAction = 'add';
    
    document.getElementById('foundProductName').textContent = product.name;
    document.getElementById('foundBarcode').textContent = barcode;
    document.getElementById('qtyDisplay').textContent = quickQty;
    document.getElementById('addBtn').classList.add('active');
    document.getElementById('subtractBtn').classList.remove('active');
    document.getElementById('quickActionModal').classList.add('active');
  }

  window.closeQuickActionModal = function() {
    document.getElementById('quickActionModal').classList.remove('active');
    quickProductId = null;
    quickScannedBarcode = null;
  };

  window.setAction = function(action) {
    quickAction = action;
    if (action === 'add') {
      document.getElementById('addBtn').classList.add('active');
      document.getElementById('subtractBtn').classList.remove('active');
    } else {
      document.getElementById('addBtn').classList.remove('active');
      document.getElementById('subtractBtn').classList.add('active');
    }
  };

  window.changeQty = function(delta) {
    quickQty = Math.max(1, quickQty + delta);
    document.getElementById('qtyDisplay').textContent = quickQty;
  };

  window.executeQuickAction = async function() {
    if (!quickProductId) {
      notify('No product selected', 'error');
      return;
    }
    
    const location = normLoc(document.getElementById('quickLocation').value);
    if (!location) {
      notify('Invalid location', 'warn');
      return;
    }
    
    try {
      const product = inventory.find(i => i.id === quickProductId);
      
      let qtyOld = product.qtyOld || 0;
      let qtyNew = product.qtyNew || 0;
      let qtyOffice = product.qtyOffice || 0;
      
      const multiplier = quickAction === 'add' ? 1 : -1;
      const change = quickQty * multiplier;
      
      if (location === 'Old warehouse') {
        qtyOld = Math.max(0, qtyOld + change);
      } else if (location === 'New warehouse') {
        qtyNew = Math.max(0, qtyNew + change);
      } else if (location === 'Office') {
        qtyOffice = Math.max(0, qtyOffice + change);
      }
      
      const totalQty = qtyOld + qtyNew + qtyOffice;
      
      await updateDoc(doc(db, "inventory", quickProductId), {
        qtyOld, qtyNew, qtyOffice, qty: totalQty, isNew: true
      });
      
      const actionText = quickAction === 'add' ? 'added to' : 'subtracted from';
      notify(`${quickQty} ${actionText} ${product.name} at ${location}`);
      closeQuickActionModal();
      
    } catch (err) {
      console.error('Error executing quick action:', err);
      notify('Failed to update stock', 'error');
    }
  };

  document.getElementById('quickActionModal').addEventListener('click', (e) => {
    if (e.target.id === 'quickActionModal') closeQuickActionModal();
  });

  /* ============================================ */
  /* FUNCTION 3: VIEW & MANAGE BARCODES          */
  /* ============================================ */

  window.openViewBarcodesModal = function() {
    const modal = document.getElementById('viewBarcodesModal');
    const barcodesList = document.getElementById('barcodesList');
    
    barcodesList.innerHTML = '';
    
    // Group barcodes by product
    const productsWithBarcodes = inventory.filter(item => (item.barcodes || []).length > 0);
    
    if (productsWithBarcodes.length === 0) {
      barcodesList.innerHTML = '<div class="no-barcodes">No barcodes registered yet. Use the üîñ Register Barcode button to get started!</div>';
    } else {
      productsWithBarcodes.forEach(product => {
        const barcodes = product.barcodes || [];
        
        const groupDiv = document.createElement('div');
        groupDiv.className = 'barcode-group';
        
        let headerHtml = `
          <div class="barcode-group-header">
            ${escapeHtml(product.name)}
            <span class="barcode-count">(${barcodes.length} barcode${barcodes.length !== 1 ? 's' : ''})</span>
          </div>
        `;
        
        let barcodesHtml = '';
        barcodes.forEach(barcode => {
          barcodesHtml += `
            <div class="barcode-item">
              <span class="barcode-code">${escapeHtml(barcode)}</span>
              <button class="barcode-remove" onclick="removeBarcode('${escapeHtml(product.id)}', '${escapeHtml(barcode)}')">Remove</button>
            </div>
          `;
        });
        
        groupDiv.innerHTML = headerHtml + barcodesHtml;
        barcodesList.appendChild(groupDiv);
      });
    }
    
    modal.classList.add('active');
  };

  window.closeViewBarcodesModal = function() {
    document.getElementById('viewBarcodesModal').classList.remove('active');
  };

  window.removeBarcode = async function(productId, barcode) {
    if (!confirm(`Remove barcode "${barcode}"?\n\nThis action cannot be undone.`)) {
      return;
    }
    
    try {
      await updateDoc(doc(db, "inventory", productId), {
        barcodes: arrayRemove(barcode)
      });
      
      notify(`Barcode removed successfully`);
      
      // Refresh the barcodes list
      openViewBarcodesModal();
      
    } catch (err) {
      console.error('Error removing barcode:', err);
      notify('Failed to remove barcode', 'error');
    }
  };

  document.getElementById('viewBarcodesModal').addEventListener('click', (e) => {
    if (e.target.id === 'viewBarcodesModal') closeViewBarcodesModal();
  });

  /* ============================================ */
  /* MANUAL ADD ITEM FUNCTION                    */
  /* ============================================ */

  async function addNewItem() {
    const name = (document.getElementById('newItemName').value || '').trim().replace(/\s+/g,' ');
    const qty  = parseInt(document.getElementById('newItemQty').value,10);
    const location = normLoc(document.getElementById('newItemLoc').value);
    if (!name || isNaN(qty) || qty <= 0) { notify("Enter a valid name and a quantity ‚â• 1","warn"); return; }
    if (!location) { notify('Location must be "Old warehouse", "New warehouse", or "Office".',"warn"); return; }

    const existing = inventory.find(i => (i.name||'').toLowerCase() === name.toLowerCase());
    try{
      if (existing) {
        const incOld    = location === 'Old warehouse' ? qty : 0;
        const incNew    = location === 'New warehouse' ? qty : 0;
        const incOffice = location === 'Office'         ? qty : 0;
        const newOld    = Math.max(0, (existing.qtyOld ?? 0)    + incOld);
        const newNew    = Math.max(0, (existing.qtyNew ?? 0)    + incNew);
        const newOffice = Math.max(0, (existing.qtyOffice ?? 0) + incOffice);
        await updateDoc(doc(db, "inventory", existing.id), {
          qtyOld: newOld, qtyNew: newNew, qtyOffice: newOffice, qty: newOld + newNew + newOffice, isNew:true
        });
      } else {
        const qtyOld    = location === 'Old warehouse' ? qty : 0;
        const qtyNew    = location === 'New warehouse' ? qty : 0;
        const qtyOffice = location === 'Office'         ? qty : 0;
        await addDoc(colInventory, {
          name, qtyOld, qtyNew, qtyOffice, qty: qtyOld + qtyNew + qtyOffice, goal:0, img:null, isNew:true, 
          barcodes: [], // Initialize empty barcodes array
          createdAt: serverTimestamp()
        });
      }
      notify(`Item "${name}" added to ${location}.`);
    } catch(err){ console.error(err); notify('Failed to add item','error'); }
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemQty').value = '';
  }
  
  window.addNewItem = addNewItem;
  window.selectProduct = selectProduct;
</script>
</body>
</html>
