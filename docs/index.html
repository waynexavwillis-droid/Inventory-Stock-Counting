<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory System ‚Äî Add New Stock</title>

<!-- Auth gate with role check -->
<script>
  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role'); // 'editor' | 'viewer'
  if (!AUTH_OK || !AUTH_USER) { window.location.replace('login.html'); }
  else if (AUTH_ROLE === 'viewer') { window.location.replace('viewer.html'); }
  function logout(){
    localStorage.removeItem('auth_v1');
    localStorage.removeItem('auth_user');
    localStorage.removeItem('auth_role');
    localStorage.removeItem('auth_time');
    window.location.replace('login.html');
  }
</script>

<style>
  :root{
    --nav-w:260px; --bg:#f6f7f8; --panel:#fff; --ink:#111; --muted:#6b7280; --line:#e5e7eb;
    --accent:#111; --accent-ink:#fff;
    --p-bg:#0f0a1f; --p-card:#1a1233; --p-ink:#e8e3ff; --p-muted:#b8acd9; --p-line:#3b2b66; --p-accent:#6d28d9;
    --s-card:#fff; --s-ink:#0f172a; --s-muted:#6b7280; --s-line:#e5e7eb; --s-badge:#e2e8f0;
  }
  html,body{height:100%} body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--ink)}
  h1,h2,h3{color:var(--ink)} .content{padding:20px;padding-top:80px;min-height:100vh;box-sizing:border-box}
  input,button,select,textarea{padding:8px;margin:4px;font-family:inherit}
  .muted{color:var(--muted);font-size:12px;margin-top:6px}
  button{background:linear-gradient(#fafafa,#f3f4f6);border:1px solid var(--line);color:var(--ink);border-radius:8px;cursor:pointer}
  button:hover{background:#111;color:#fff;border-color:#111}

  /* Sidebar + hamburger */
  #menu-check{display:none}
  .hamburger{position:fixed;left:12px;top:12px;width:32px;display:flex;flex-direction:column;gap:7px;cursor:pointer;user-select:none;z-index:1200;transition:transform .3s}
  .hamburger .bar{height:3px;background:#111;border-radius:10px;transition:transform .35s,opacity .25s,width .35s}
  .hamburger .bar1,.hamburger .bar3{width:18px}.hamburger .bar2{width:28px}
  #menu-check:checked+label.hamburger{transform:translateX(var(--nav-w))}
  #menu-check:checked+label.hamburger .bar1{transform:translateY(10px) rotate(45deg);width:28px}
  #menu-check:checked+label.hamburger .bar2{opacity:0}
  #menu-check:checked+label.hamburger .bar3{transform:translateY(-10px) rotate(-45deg);width:28px}
  .sidebar{position:fixed;inset:0 auto 0 0;width:var(--nav-w);background:#f3f4f6;padding:20px;box-sizing:border-box;transform:translateX(-100%);transition:.3s;z-index:1100;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.18);border-right:1px solid var(--line)}
  .sidebar a,.sidebar button{display:block;width:100%;margin-bottom:10px;padding:10px;text-align:left;border-radius:8px;text-decoration:none;color:inherit;border:1px solid var(--line);background:#fff}
  .sidebar a:hover{background:#111;color:#fff;border-color:#111}
  #menu-check:checked~.sidebar{transform:translateX(0)}
  label.overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);opacity:0;visibility:hidden;transition:.3s;z-index:1090}
  #menu-check:checked~label.overlay{opacity:1;visibility:visible}

  /* Fancy input */
  .input-container{position:relative;margin:8px 4px}
  .input{width:100%;padding:10px;height:40px;border:2px solid var(--ink);border-top:none;border-bottom:none;font-size:16px;background:transparent;outline:none;box-shadow:7px 7px 0 0 var(--ink);transition:.5s;box-sizing:border-box}
  .input:focus{box-shadow:none}
  .label{position:absolute;top:10px;left:10px;color:var(--ink);transition:.5s;transform:scale(0);z-index:-1;background:#fff;padding:0 4px}
  .topline,.underline{position:absolute;background-color:var(--ink);height:2px;right:0;transition:.5s}
  .topline{width:0%;top:0}.underline{width:0%;bottom:0}
  .input-container input:focus~.topline{width:35%}.input-container input:focus~.underline{width:100%}.input-container input:focus~.label{top:-10px;transform:scale(1)}
  /* Helper card */
  .helper-row{display:grid;grid-template-columns:1fr;gap:16px;margin-top:12px}
  .card.helper{width:100%;border-radius:15px;box-shadow:1px 5px 60px 0 #100a;background:#0f0a1f;color:#fff;padding:16px}
  .card-border-top{width:60%;height:3px;background:#6d28d9;margin:6px auto 10px;border-radius:0 0 15px 15px}
  .card.helper .img{width:70px;height:70px;background:#1a1233;border-radius:15px;margin:14px auto 6px;display:flex;align-items:center;justify-content:center;font-size:24px}
  .card.helper span{display:block;text-align:center}
  .card.helper .job{font-size:12px;opacity:.85}
  .card.helper button{padding:10px 16px;display:block;margin:12px auto 6px;border-radius:8px;border:1px solid #6d28d9;background:#6d28d9;color:#fff;font-weight:600;cursor:pointer}
  .card.helper button:hover{filter:brightness(.92)}
  .helper-note{text-align:center;font-size:12px;color:#b8acd9;margin-top:4px}

  /* Toasts */
  .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
  .toast{background:#111;color:#fff;padding:10px 12px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:86vw}
  .toast--warn{background:#b45309}.toast--error{background:#991b1b}.toast__close{margin-left:12px;cursor:pointer;font-weight:700}
</style>
</head>
<body>

<!-- Toggle checkbox + hamburger -->
<input id="menu-check" type="checkbox" />
<label for="menu-check" class="hamburger" aria-label="Toggle menu" aria-controls="side" role="button" tabindex="0">
  <span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span>
</label>

<!-- Off-canvas sidebar -->
<nav class="sidebar" id="side" role="navigation" aria-label="Main">
  <a href="index.html">Add New Stock</a>
  <a href="adjust.html">Adjust Stock</a>
  <a href="location.html">Location</a>
  <a href="goal.html">Set Stock Count Goal</a>
  <a href="history.html">History</a>
  <a href="status.html">Status</a>
  <hr>
  <button onclick="logout()">Logout</button>
</nav>

<!-- Click-away overlay -->
<label class="overlay" for="menu-check" aria-hidden="true"></label>

<!-- Toast container -->
<div class="toast-wrap" id="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<main class="content">
  <section aria-labelledby="addPageTitle">
    <h2 id="addPageTitle">Add New Item</h2>
    <div class="add-row" style="display:grid;grid-template-columns:minmax(260px,1fr) 160px minmax(220px,1fr) auto;gap:12px;align-items:center;max-width:900px">
      <div class="input-container">
        <input type="text" id="newItemName" class="input" placeholder=" " autocomplete="off" />
        <span class="topline"></span><span class="underline"></span>
        <label for="newItemName" class="label">Item Name</label>
      </div>
      <input type="number" id="newItemQty" placeholder="Quantity" min="1" inputmode="numeric" aria-label="Quantity" />
      <div class="input-container">
        <select id="newItemLoc" class="input" style="height:40px">
          <option>Old warehouse</option><option>New warehouse</option>
        </select>
        <span class="topline"></span><span class="underline"></span>
        <label for="newItemLoc" class="label">Location</label>
      </div>
      <button onclick="addNewItem()" aria-label="Add Item">Add Item</button>
    </div>

    <div class="helper-row">
      <div class="card helper" aria-label="Image Helper">
        <div class="card-border-top"></div>
        <div class="img">üñºÔ∏è</div>
        <span>Need an image URL?</span>
        <span class="job">Upload to imgbb, copy the link, then set it via the üñº button on an item.</span>
        <button type="button" onclick="openImgbb()">Open imgbb.com</button>
        <div class="helper-note">Tip: choose ‚ÄúDirect link‚Äù if available.</div>
      </div>
    </div>

    <div class="muted">Signed in as <strong id="signedAs"></strong>. Data syncs via Firebase (Firestore + Storage).</div>
  </section>
</main>

<!-- Firebase + App Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
    authDomain: "epedu-inventory-database.firebaseapp.com",
    projectId: "epedu-inventory-database",
    storageBucket: "epedu-inventory-database.appspot.com",
    messagingSenderId: "124437251040",
    appId: "1:124437251040:web:4989c73efc2f4afbf22185",
    measurementId: "G-GFEEP49VRP"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) {}
  const auth = getAuth(app);
  const db   = getFirestore(app);
  signInAnonymously(auth).catch(console.error);

  const CURRENT_USER = localStorage.getItem('auth_user') || 'Unknown';
  const signedAs = document.getElementById('signedAs'); if (signedAs) signedAs.textContent = CURRENT_USER;

  /* Toasts */
  const toastWrap = document.getElementById('toast-wrap');
  function toast(msg, type='info', timeout=3200){
    const el = document.createElement('div');
    el.className = 'toast' + (type==='warn' ? ' toast--warn' : type==='error' ? ' toast--error' : '');
    el.innerHTML = `${escapeHtml(msg)} <span class="toast__close" aria-label="Dismiss" role="button">√ó</span>`;
    toastWrap.appendChild(el);
    const close = ()=>{ if (el && el.parentNode) el.parentNode.removeChild(el); };
    el.querySelector('.toast__close').addEventListener('click', close);
    if (timeout>0) setTimeout(close, timeout);
  }
  const notify = toast;

  /* Utils */
  function escapeHtml(s){ return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function normLoc(raw){
    const s=(raw||'').trim().toLowerCase();
    if (s.startsWith('old')) return 'Old warehouse';
    if (s.startsWith('new')) return 'New warehouse';
    if (['old warehouse','new warehouse'].includes(s)) return s.replace(/\b\w/g,m=>m.toUpperCase());
    return null;
  }

  /* Sidebar ARIA */
  const menuCheck = document.getElementById('menu-check');
  const hamb = document.querySelector('label.hamburger');
  function syncAria(){ hamb.setAttribute('aria-expanded', String(menuCheck.checked)); }
  menuCheck.addEventListener('change', syncAria); syncAria();

  /* Firestore refs */
  const colInventory = collection(db, "inventory");

  /* Keep a local copy of inventory so addNewItem can merge quantities if item exists */
  let inventory = [];
  onSnapshot(colInventory, (snap) => { inventory = snap.docs.map(d => ({ id:d.id, ...d.data() })); });

  /* Open imgbb */
  window.openImgbb = () => window.open('https://imgbb.com', '_blank', 'noopener');

  /* Add item */
  async function addNewItem() {
    const name = (document.getElementById('newItemName').value || '').trim().replace(/\s+/g,' ');
    const qty  = parseInt(document.getElementById('newItemQty').value,10);
    const location = normLoc(document.getElementById('newItemLoc').value);
    if (!name || isNaN(qty) || qty <= 0) { notify("Enter a valid name and a quantity ‚â• 1","warn"); return; }
    if (!location) { notify('Location must be "Old warehouse" or "New warehouse".',"warn"); return; }

    const existing = inventory.find(i => (i.name||'').toLowerCase() === name.toLowerCase());
    try{
      if (existing) {
        const incOld = location === 'Old warehouse' ? qty : 0;
        const incNew = location === 'New warehouse' ? qty : 0;
        const newOld = Math.max(0, (existing.qtyOld ?? 0) + incOld);
        const newNew = Math.max(0, (existing.qtyNew ?? 0) + incNew);
        await updateDoc(doc(db, "inventory", existing.id), { qtyOld: newOld, qtyNew: newNew, qty: newOld + newNew, isNew:true });
      } else {
        const qtyOld = location === 'Old warehouse' ? qty : 0;
        const qtyNew = location === 'New warehouse' ? qty : 0;
        await addDoc(colInventory, { name, qtyOld, qtyNew, qty: qtyOld + qtyNew, goal:0, img:null, isNew:true, createdAt: serverTimestamp() });
      }
      notify(`Item "${name}" added to ${location}.`);
    } catch(err){ console.error(err); notify('Failed to add item','error'); }
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemQty').value = '';
  }
  window.addNewItem = addNewItem;
</script>
</body>
</html>
