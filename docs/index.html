<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory System ‚Äî Add New Stock</title>

<!-- Auth gate with role check (GitHub Pages‚Äìsafe redirects) -->
<script>
  function ghBase(file) {
    // If hosted on GitHub Pages project site, prefix with "/REPO/"
    if (location.hostname.endsWith('github.io')) {
      const parts = location.pathname.split('/').filter(Boolean);
      const repo = parts.length > 0 ? parts[0] : '';
      return (repo ? `/${repo}/` : '/') + file;
    }
    return file; // local dev or custom domain
  }

  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role'); // 'admin' | 'editor' | 'viewer'

  if (!AUTH_OK || !AUTH_USER) {
    window.location.replace(ghBase('login.html'));
  } else if (AUTH_ROLE === 'viewer') {
    window.location.replace(ghBase('viewer.html'));
  }

  function logout(){
    localStorage.removeItem('auth_v1');
    localStorage.removeItem('auth_user');
    localStorage.removeItem('auth_role');
    localStorage.removeItem('auth_time');
    window.location.replace(ghBase('login.html'));
  }
  window.logout = logout; // used by sidebar button
</script>

<style>
  /* ==== Light theme based on #F7F4EA ==== */
  :root{
    --nav-w:260px;

    /* Theme */
    --bg:#F7F4EA;        /* paper background */
    --panel:#EEE6D8;     /* cards / panels */
    --ink:#1F2937;       /* primary text */
    --muted:#6B7280;     /* muted text */
    --line:#D9CFC1;      /* borders/outlines */
    --accent:#0EA5A4;    /* teal accent */
    --chip:#EDE7DA;      /* subtle chip/pill bg */

    /* Helper card accents */
    --helper-accent:#6D28D9;  /* purple accent line (kept as a fun pop) */
    --helper-panel:#F3ECDF;   /* light panel inside helper */
  }

  html,body{height:100%}
  body{
    margin:0;
    font-family:Arial,sans-serif;
    background:var(--bg);
    color:var(--ink)
  }
  h1,h2,h3{color:var(--ink)}
  .content{padding:20px;padding-top:80px;min-height:100vh;box-sizing:border-box}

  /* Controls ‚Äî legibility & theme consistency */
  input,button,select,textarea{
    padding:8px;margin:4px;font-family:inherit;
    color:var(--ink);
    background:var(--panel);
    border:1px solid var(--line);
    caret-color:var(--ink);
  }
  input::placeholder, textarea::placeholder{ color:var(--muted); opacity:1 }

  button{
    border-radius:8px;
    cursor:pointer;
    transition:.15s ease;
  }
  button:hover{
    background:var(--accent);
    color:#ffffff;
    border-color:var(--accent);
  }

  .muted{color:var(--muted);font-size:12px;margin-top:6px}

  /* Sidebar + hamburger */
  #menu-check{display:none}
  .hamburger{
    position:fixed;left:12px;top:12px;width:32px;display:flex;flex-direction:column;gap:7px;
    cursor:pointer;user-select:none;z-index:1200;transition:transform .3s
  }
  .hamburger .bar{
    height:3px;background:var(--ink);border-radius:10px;
    transition:transform .35s,opacity .25s,width .35s
  }
  .hamburger .bar1,.hamburger .bar3{width:18px}.hamburger .bar2{width:28px}
  #menu-check:checked+label.hamburger{transform:translateX(var(--nav-w))}
  #menu-check:checked+label.hamburger .bar1{transform:translateY(10px) rotate(45deg);width:28px}
  #menu-check:checked+label.hamburger .bar2{opacity:0}
  #menu-check:checked+label.hamburger .bar3{transform:translateY(-10px) rotate(-45deg);width:28px}

  .sidebar{
    position:fixed;inset:0 auto 0 0;width:var(--nav-w);
    background:var(--panel);padding:20px;box-sizing:border-box;
    transform:translateX(-100%);transition:.3s;z-index:1100;overflow:auto;
    box-shadow:0 10px 30px rgba(0,0,0,.08);border-right:1px solid var(--line)
  }
  .sidebar a,.sidebar button{
    display:block;width:100%;margin-bottom:10px;padding:10px;text-align:left;border-radius:8px;text-decoration:none;
    color:inherit;border:1px solid var(--line);background:transparent
  }
  .sidebar a:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  #menu-check:checked~.sidebar{transform:translateX(0)}
  label.overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;visibility:hidden;transition:.3s;z-index:1090}
  #menu-check:checked~label.overlay{opacity:1;visibility:visible}

  /* Fancy input (uses theme vars) */
  .input-container{position:relative;margin:8px 4px}
  .input{
    width:100%;padding:10px;height:40px;
    border:2px solid var(--line);
    border-top:none;border-bottom:none;
    font-size:16px;background:transparent;outline:none;
    box-shadow:7px 7px 0 0 var(--line);
    transition:.5s;box-sizing:border-box;
    color:var(--ink);caret-color:var(--ink);
  }
  .label{
    position:absolute;top:10px;left:10px;color:var(--ink);
    transition:.5s;transform:scale(0);z-index:-1;background:var(--bg);padding:0 4px
  }
  .topline,.underline{position:absolute;background-color:var(--line);height:2px;right:0;transition:.5s}
  .topline{width:0}.underline{width:0;bottom:0}
  .input-container input:focus~.topline{width:35%}
  .input-container input:focus~.underline{width:100%}
  .input-container input:focus~.label{top:-10px;transform:scale(1)}
  .input-container select{appearance:none}

  /* Helper card (themed) */
  .helper-row{display:grid;grid-template-columns:1fr;gap:16px;margin-top:12px}
  @media (min-width: 600px) {
    .helper-row{grid-template-columns:1fr 1fr}
  }
  .card.helper{
    width:100%;border-radius:15px;background:var(--helper-panel);color:var(--ink);padding:16px;
    box-shadow:0 8px 22px rgba(0,0,0,.08);border:1px solid var(--line)
  }
  .card-border-top{width:60%;height:3px;background:var(--helper-accent);margin:6px auto 10px;border-radius:0 0 15px 15px}
  .card.helper .img{
    width:70px;height:70px;background:var(--panel);border-radius:15px;margin:14px auto 6px;
    display:flex;align-items:center;justify-content:center;font-size:24px;border:1px solid var(--line)
  }
  .card.helper span{display:block;text-align:center}
  .card.helper .job{font-size:12px;color:var(--muted)}
  .card.helper button{
    padding:10px 16px;display:block;margin:12px auto 6px;border-radius:8px;border:1px solid var(--accent);
    background:var(--accent);color:#fff;font-weight:600;cursor:pointer
  }
  .card.helper button:hover{filter:brightness(.95)}
  .helper-note{text-align:center;font-size:12px;color:var(--muted);margin-top:4px}

  /* Barcode Scanner Button */
  .scanner-btn{
    background:var(--helper-accent);
    border-color:var(--helper-accent);
    color:#fff;
    font-size:20px;
    padding:10px 16px;
    min-width:50px;
  }
  .scanner-btn:hover{
    filter:brightness(.9);
  }

  /* Scanner Modal */
  .scanner-modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.85);
    z-index:2000;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .scanner-modal.active{display:flex}
  .scanner-content{
    background:var(--panel);
    border-radius:12px;
    padding:20px;
    max-width:600px;
    width:100%;
    box-shadow:0 20px 60px rgba(0,0,0,.3);
  }
  .scanner-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
  }
  .scanner-header h3{margin:0}
  .scanner-close{
    background:transparent;
    border:none;
    font-size:28px;
    cursor:pointer;
    padding:0;
    width:32px;
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--ink);
  }
  .scanner-close:hover{
    background:var(--line);
    border-radius:50%;
  }
  #reader{
    border:2px solid var(--line);
    border-radius:8px;
    overflow:hidden;
    background:#000;
  }
  .scanner-result{
    margin-top:12px;
    padding:12px;
    background:var(--bg);
    border-radius:8px;
    border:1px solid var(--accent);
    display:none;
  }
  .scanner-result.active{display:block}
  .scanner-result strong{color:var(--accent)}

  /* Toasts */
  .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
  .toast{
    background:#E9E2D6;color:var(--ink);padding:10px 12px;border-radius:8px;
    box-shadow:0 10px 30px rgba(0,0,0,.12);max-width:86vw
  }
  .toast--warn{background:#F2C97D;color:#4A2E00}.toast--error{background:#F3B8B8;color:#711313}
  .toast__close{margin-left:12px;cursor:pointer;font-weight:700}
</style>
</head>
<body>

<!-- Toggle checkbox + hamburger -->
<input id="menu-check" type="checkbox" />
<label for="menu-check" class="hamburger" aria-label="Toggle menu" aria-controls="side" role="button" tabindex="0">
  <span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span>
</label>

<!-- Off-canvas sidebar -->
<nav class="sidebar" id="side" role="navigation" aria-label="Main">
  <a href="index.html">Add New Stock</a>
  <a href="adjust.html">Adjust Stock</a>
  <a href="location.html">Location</a>
  <a href="goal.html">Set Stock Count Goal</a>
  <a href="history.html">History</a>
  <a href="status.html">Status</a>
  <a href="loan.html">Loan</a>
  <hr>
  <button onclick="logout()">Logout</button>
</nav>

<!-- Click-away overlay -->
<label class="overlay" for="menu-check" aria-hidden="true"></label>

<!-- Toast container -->
<div class="toast-wrap" id="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<!-- Barcode Scanner Modal -->
<div class="scanner-modal" id="scannerModal">
  <div class="scanner-content">
    <div class="scanner-header">
      <h3>Scan Barcode</h3>
      <button class="scanner-close" onclick="closeScanner()" aria-label="Close scanner">√ó</button>
    </div>
    <div id="reader"></div>
    <div class="scanner-result" id="scannerResult">
      <strong>Scanned:</strong> <span id="scannedCode"></span>
    </div>
  </div>
</div>

<main class="content">
  <section aria-labelledby="addPageTitle">
    <h2 id="addPageTitle">Add New Item</h2>
    <div class="add-row" style="display:grid;grid-template-columns:minmax(260px,1fr) 160px minmax(220px,1fr) auto auto;gap:12px;align-items:center;max-width:1000px">
      <div class="input-container">
        <input type="text" id="newItemName" class="input" placeholder=" " autocomplete="off" />
        <span class="topline"></span><span class="underline"></span>
        <label for="newItemName" class="label">Item Name</label>
      </div>
      <input type="number" id="newItemQty" placeholder="Quantity" min="1" inputmode="numeric" aria-label="Quantity" />
      <div class="input-container">
        <select id="newItemLoc" class="input" style="height:40px">
          <option>Old warehouse</option>
          <option>New warehouse</option>
          <option>Office</option>
        </select>
        <span class="topline"></span><span class="underline"></span>
        <label for="newItemLoc" class="label">Location</label>
      </div>
      <button class="scanner-btn" onclick="openScanner()" aria-label="Scan Barcode" title="Scan Barcode">üì∑</button>
      <button onclick="addNewItem()" aria-label="Add Item">Add Item</button>
    </div>

    <div class="helper-row">
      <div class="card helper" aria-label="Barcode Scanner Helper">
        <div class="card-border-top"></div>
        <div class="img">üì∑</div>
        <span>Quick Barcode Scan</span>
        <span class="job">Click the camera button to scan barcodes with your device camera. The scanned code will auto-fill the item name.</span>
        <button type="button" onclick="openScanner()">Open Scanner</button>
        <div class="helper-note">Tip: Works with most 1D and 2D barcodes.</div>
      </div>
      
      <div class="card helper" aria-label="Image Helper">
        <div class="card-border-top"></div>
        <div class="img">üñºÔ∏è</div>
        <span>Need an image URL?</span>
        <span class="job">Upload to ImageKit, copy the link, then set it via the üñº button on an item.</span>
        <button type="button" onclick="openImgbb()">Open ImageKit</button>
        <div class="helper-note">Tip: choose "Direct link" if available.</div>
      </div>
    </div>

    <div class="muted">Signed in as <strong id="signedAs"></strong>. Data syncs via Firebase (Firestore + Storage).</div>
  </section>
</main>

<!-- HTML5 QR Code Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- Firebase + App Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
    authDomain: "epedu-inventory-database.firebaseapp.com",
    projectId: "epedu-inventory-database",
    storageBucket: "epedu-inventory-database.appspot.com",
    messagingSenderId: "124437251040",
    appId: "1:124437251040:web:4989c73efc2f4afbf22185",
    measurementId: "G-GFEEP49VRP"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e) {}
  const auth = getAuth(app);
  const db   = getFirestore(app);
  signInAnonymously(auth).catch(console.error);

  const CURRENT_USER = localStorage.getItem('auth_user') || 'Unknown';
  const signedAs = document.getElementById('signedAs'); if (signedAs) signedAs.textContent = CURRENT_USER;

  /* Toasts */
  const toastWrap = document.getElementById('toast-wrap');
  function toast(msg, type='info', timeout=3200){
    const el = document.createElement('div');
    el.className = 'toast' + (type==='warn' ? ' toast--warn' : type==='error' ? ' toast--error' : '');
    el.innerHTML = `${escapeHtml(msg)} <span class="toast__close" aria-label="Dismiss" role="button">√ó</span>`;
    toastWrap.appendChild(el);
    const close = ()=>{ if (el && el.parentNode) el.parentNode.removeChild(el); };
    el.querySelector('.toast__close').addEventListener('click', close);
    if (timeout>0) setTimeout(close, timeout);
  }
  const notify = toast;

  /* Utils */
  function escapeHtml(s){ return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function normLoc(raw){
    const s=(raw||'').trim().toLowerCase();
    if (s.startsWith('old')) return 'Old warehouse';
    if (s.startsWith('new')) return 'New warehouse';
    if (s.startsWith('off')) return 'Office';
    if (['old warehouse','new warehouse','office'].includes(s)) return s.replace(/\b\w/g,m=>m.toUpperCase());
    return null;
  }

  /* Sidebar ARIA */
  const menuCheck = document.getElementById('menu-check');
  const hamb = document.querySelector('label.hamburger');
  function syncAria(){ hamb.setAttribute('aria-expanded', String(menuCheck.checked)); }
  menuCheck.addEventListener('change', syncAria); syncAria();

  /* Firestore refs */
  const colInventory = collection(db, "inventory");

  /* Keep a local copy of inventory so addNewItem can merge quantities if item exists */
  let inventory = [];
  onSnapshot(colInventory, (snap) => { inventory = snap.docs.map(d => ({ id:d.id, ...d.data() })); });

  /* Open ImageKit */
  window.openImgbb = () => window.open('https://imagekit.io/dashboard/media-library/L0VQRURVIElOVkVOVE9SWSA', '_blank', 'noopener');

  /* Barcode Scanner */
  let html5QrCode = null;
  let scannerActive = false;

  window.openScanner = async function() {
    const modal = document.getElementById('scannerModal');
    const resultDiv = document.getElementById('scannerResult');
    
    modal.classList.add('active');
    resultDiv.classList.remove('active');
    
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("reader");
    }

    if (scannerActive) return;

    try {
      await html5QrCode.start(
        { facingMode: "environment" }, // Use rear camera
        {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
        },
        (decodedText, decodedResult) => {
          // Success callback - barcode scanned
          document.getElementById('scannedCode').textContent = decodedText;
          document.getElementById('scannerResult').classList.add('active');
          
          // Auto-fill the item name with the scanned barcode
          document.getElementById('newItemName').value = decodedText;
          
          notify(`Barcode scanned: ${decodedText}`);
          
          // Auto-close scanner after 1.5 seconds
          setTimeout(() => {
            closeScanner();
          }, 1500);
        },
        (errorMessage) => {
          // Error callback - scanning failed (this is called continuously, so we don't log it)
        }
      );
      scannerActive = true;
    } catch (err) {
      console.error("Unable to start scanner:", err);
      notify("Unable to access camera. Please check permissions.", "error");
      modal.classList.remove('active');
    }
  };

  window.closeScanner = async function() {
    if (html5QrCode && scannerActive) {
      try {
        await html5QrCode.stop();
        scannerActive = false;
      } catch (err) {
        console.error("Error stopping scanner:", err);
      }
    }
    document.getElementById('scannerModal').classList.remove('active');
    document.getElementById('scannerResult').classList.remove('active');
  };

  // Close scanner when clicking outside the content area
  document.getElementById('scannerModal').addEventListener('click', (e) => {
    if (e.target.id === 'scannerModal') {
      closeScanner();
    }
  });

  /* Add item (supports Office) */
  async function addNewItem() {
    const name = (document.getElementById('newItemName').value || '').trim().replace(/\s+/g,' ');
    const qty  = parseInt(document.getElementById('newItemQty').value,10);
    const location = normLoc(document.getElementById('newItemLoc').value);
    if (!name || isNaN(qty) || qty <= 0) { notify("Enter a valid name and a quantity ‚â• 1","warn"); return; }
    if (!location) { notify('Location must be "Old warehouse", "New warehouse", or "Office".',"warn"); return; }

    const existing = inventory.find(i => (i.name||'').toLowerCase() === name.toLowerCase());
    try{
      if (existing) {
        const incOld    = location === 'Old warehouse' ? qty : 0;
        const incNew    = location === 'New warehouse' ? qty : 0;
        const incOffice = location === 'Office'         ? qty : 0;
        const newOld    = Math.max(0, (existing.qtyOld ?? 0)    + incOld);
        const newNew    = Math.max(0, (existing.qtyNew ?? 0)    + incNew);
        const newOffice = Math.max(0, (existing.qtyOffice ?? 0) + incOffice);
        await updateDoc(doc(db, "inventory", existing.id), {
          qtyOld: newOld, qtyNew: newNew, qtyOffice: newOffice, qty: newOld + newNew + newOffice, isNew:true
        });
      } else {
        const qtyOld    = location === 'Old warehouse' ? qty : 0;
        const qtyNew    = location === 'New warehouse' ? qty : 0;
        const qtyOffice = location === 'Office'         ? qty : 0;
        await addDoc(colInventory, {
          name, qtyOld, qtyNew, qtyOffice, qty: qtyOld + qtyNew + qtyOffice, goal:0, img:null, isNew:true, createdAt: serverTimestamp()
        });
      }
      notify(`Item "${name}" added to ${location}.`);
    } catch(err){ console.error(err); notify('Failed to add item','error'); }
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemQty').value = '';
  }
  window.addNewItem = addNewItem;
</script>
</body>
</html>
