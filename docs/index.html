<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory System with Alerts</title>

  <!-- Auth gate -->
  <script>
    if (localStorage.getItem('auth_v1') !== 'ok') {
      window.location.replace('login.html');
    }
    function logout(){
      localStorage.removeItem('auth_v1');
      localStorage.removeItem('auth_time');
      window.location.replace('login.html');
    }
  </script>

  <style>
    :root{
      /* sizes */
      --nav-w: 260px;

      /* ===== Black & Gray Minimal Theme ===== */
      --bg:#f6f7f8;         /* page background */
      --panel:#ffffff;      /* cards/panels */
      --ink:#111111;        /* primary text (near-black) */
      --muted:#6b7280;      /* secondary text */
      --line:#e5e7eb;       /* borders */
      --accent:#111111;     /* buttons / accents */
      --accent-ink:#ffffff; /* accent text */
    }

    /* ===== Base ===== */
    html,body{ height:100%; }
    body{ margin:0; font-family: Arial, sans-serif; background:var(--bg); color:var(--ink); }
    h1,h2,h3{ color:var(--ink); }
    .content{ padding:20px; box-sizing:border-box; min-height:100vh; overflow:auto; }
    input, button{ padding:8px; margin:4px; }
    table{ width:100%; margin-top:12px; border-collapse:collapse; }
    table, th, td{ border:1px solid var(--line); }
    thead th{ background:#f3f4f6; color:var(--muted); }
    th, td{ padding:8px; text-align:left; vertical-align:top; }
    .muted{ color:var(--muted); font-size:12px; margin-top:6px; }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    .pill{ display:inline-block; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:#555; }
    .nowrap{ white-space:nowrap; }

    /* ===== Buttons (global) ===== */
    button{
      background:linear-gradient(#fafafa,#f3f4f6);
      border:1px solid var(--line);
      color:var(--ink);
      border-radius:8px;
      cursor:pointer;
    }
    button:hover{ background:#111; color:#fff; border-color:#111; }

    /* ===== Off-canvas sidebar (hidden by default) ===== */
    #menu-check{ display:none; } /* the toggle */

    /* Animated hamburger (CSS-only; inspired by your snippet) */
    .hamburger{
      position:fixed; left:12px; top:12px; z-index:1100;
      width:32px; display:flex; flex-direction:column; gap:7px; cursor:pointer; user-select:none;
    }
    .hamburger .bar{
      height:3px; background:#111; border-radius:10px;
      transition:transform .35s ease, opacity .25s ease, width .35s ease;
    }
    .hamburger .bar.bar1, .hamburger .bar.bar3 { width:18px; }
    .hamburger .bar.bar2 { width:28px; }

    /* animate to X when open */
    #menu-check:checked + label.hamburger .bar1{
      transform: translateY(10px) rotate(45deg);
      width:28px;
    }
    #menu-check:checked + label.hamburger .bar2{ opacity:0; }
    #menu-check:checked + label.hamburger .bar3{
      transform: translateY(-10px) rotate(-45deg);
      width:28px;
    }

    /* Drawer panel */
    .sidebar{
      position:fixed; inset:0 auto 0 0; width:var(--nav-w);
      background:#f3f4f6; padding:20px; box-sizing:border-box;
      transform:translateX(-100%); transition:transform .3s ease;
      z-index:1050; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.18);
      border-right:1px solid var(--line);
    }
    .sidebar button{
      display:block; width:100%; margin-bottom:10px; padding:10px; text-align:left;
    }
    .sidebar hr{ margin:12px 0; }
    /* show when checked */
    #menu-check:checked ~ .sidebar{ transform:translateX(0); }

    /* click-away overlay */
    label.overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      opacity:0; visibility:hidden; transition:.3s ease; z-index:1040;
    }
    #menu-check:checked ~ label.overlay{ opacity:1; visibility:visible; }

    /* ===== Cards/Grid (Adjust page) ===== */
    .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(190px, 1fr)); gap:16px; }
    .card{
      --card-bg: var(--panel);
      --card-accent: var(--accent);
      --card-text: var(--ink);
      width:190px; height:254px; background:var(--panel); border-radius:20px; position:relative; overflow:hidden;
      transition:all .5s cubic-bezier(.16,1,.3,1);
      box-shadow:0 12px 30px rgba(0,0,0,.07);
      border:1px solid var(--line);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
    }
    .card__shine{position:absolute; inset:0; background:linear-gradient(120deg, rgba(255,255,255,0) 40%, rgba(255,255,255,.8) 50%, rgba(255,255,255,0) 60%); opacity:0; transition:opacity .3s;}
    .card__glow{position:absolute; inset:-10px; background:radial-gradient(circle at 50% 0%, rgba(17,17,17,.08) 0%, rgba(17,17,17,0) 70%); opacity:0; transition:opacity .5s;}
    .card__content{padding:1.25em; height:100%; display:flex; flex-direction:column; gap:.75em; position:relative; z-index:2;}
    .card__badge{position:absolute; top:12px; right:12px; background:#111; color:#fff; padding:.25em .5em; border-radius:999px; font-size:.7em; font-weight:600; transform:scale(.8); opacity:0; transition:all .4s ease .1s;}
    .card__image{width:100%; height:100px; background:linear-gradient(180deg,#f3f4f6 0%, #e5e7eb 100%); border-radius:12px; transition:all .5s cubic-bezier(.16,1,.3,1); position:relative; overflow:hidden;}
    .qty-badge{position:absolute; bottom:8px; right:8px; background:#111; color:#fff; font-size:12px; padding:2px 6px; border-radius:999px; opacity:.9;}
    .card__text{display:flex; flex-direction:column; gap:.25em;}
    .card__title{ color:var(--ink); font-size:1.1em; margin:0; font-weight:700; transition:all .3s; }
    .card__description{ color:var(--muted); font-size:.75em; margin:0; opacity:1; transition:all .3s; }
    .card__actions{ display:flex; justify-content:center; gap:12px; margin-top:8px; }
    .card__button{ width:28px; height:28px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; cursor:pointer; transition:all .3s; transform:scale(.9); user-select:none; }
    .card__button--minus{ background:#2b2b2b; }
    .card__button--trash{
      background:transparent; color:var(--ink);
      border:1px solid var(--ink); border-radius:50%;
    }
    .card:hover{ transform:translateY(-8px); border-color:var(--line); }
    .card:hover .card__shine{ opacity:1; animation:shine 3s infinite; }
    @keyframes shine { 0%{background-position:-100% 0} 100%{background-position:200% 0} }

    /* ===== Modals ===== */
    .modal{ position: fixed; inset: 0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.4); z-index: 9999; }
    .modal.open{ display:flex; }
    .modal-card{ width:95%; max-width:460px; background:#fff; border-radius:8px; padding:16px 18px; box-shadow:0 20px 40px rgba(0,0,0,.15); border:1px solid var(--line); }
    .modal-card h3{ margin:0 0 10px; }
    .modal-card label{ display:block; margin:10px 0 4px; font-size:14px; }
    .modal-card input{ width:100%; box-sizing:border-box; padding:8px; }
    .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
    #adj-confirm, #del-confirm{ background:#111; color:#fff; border-color:#111; border-radius:8px; }
    #adj-confirm:hover, #del-confirm:hover{ filter:brightness(0.9); }

    /* ===== Fancy input styling ===== */
    .input-container{ position: relative; margin: 8px 4px; }
    .input{
      width: 100%; padding: 10px; height: 40px;
      border: 2px solid var(--ink); border-top:none; border-bottom:none;
      font-size: 16px; background: transparent; outline:none;
      box-shadow: 7px 7px 0 0 var(--ink); transition: all 0.5s; box-sizing:border-box;
    }
    .input:focus{ box-shadow:none; transition:all .5s; }
    .label{ position:absolute; top:10px; left:10px; color:var(--ink); transition: all .5s; transform: scale(0); z-index:-1; background:#fff; padding:0 4px; }
    .input-container .topline, .input-container .underline{ position:absolute; background-color: var(--ink); height:2px; right:0; transition: all .5s; }
    .input-container .topline{ width:0%; top:0; }
    .input-container .underline{ width:0%; bottom:0; }
    .input-container input:focus ~ .topline{ width:35%; }
    .input-container input:focus ~ .underline{ width:100%; }
    .input-container input:focus ~ .label{ top:-10px; transform: scale(1); }

    /* Add page layout */
    #addPage{ max-width: 800px; margin: 0 auto; }
    #addPage .input-container{ max-width: 560px; }
    #addPage input[type="number"]{ width: 140px; box-sizing: border-box; }
    .add-row{ display:grid; grid-template-columns: minmax(280px, 1fr) 140px auto; gap: 12px; align-items:center; max-width:800px; }
    .add-row .input-container, .add-row .input{ width:100%; }
    @media (max-width: 560px){ .add-row{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <!-- Toggle checkbox + hamburger (animated) -->
  <input id="menu-check" type="checkbox" />
  <label for="menu-check" class="hamburger" aria-label="Toggle menu" aria-controls="side">
    <span class="bar bar1"></span>
    <span class="bar bar2"></span>
    <span class="bar bar3"></span>
  </label>

  <!-- Off-canvas sidebar -->
  <nav class="sidebar" id="side" role="navigation" aria-label="Main">
    <button onclick="document.getElementById('menu-check').checked=false; showPage('addPage')">Add New Stock</button>
    <button onclick="document.getElementById('menu-check').checked=false; showPage('adjustPage')">Adjust Stock</button>
    <button onclick="document.getElementById('menu-check').checked=false; showPage('goalPage')">Set Stock Count Goal</button>
    <button onclick="document.getElementById('menu-check').checked=false; showPage('historyPage')">History</button>
    <hr>
    <button onclick="logout()">Logout</button>
  </nav>

  <!-- Click-away overlay -->
  <label class="overlay" for="menu-check" aria-hidden="true"></label>

  <main class="content">
    <!-- Add New Stock Page -->
    <section id="addPage">
      <h2>Add New Item</h2>
      <div class="add-row">
        <div class="input-container">
          <input type="text" id="newItemName" class="input" placeholder=" " />
          <span class="topline"></span><span class="underline"></span>
          <label for="newItemName" class="label">Item Name</label>
        </div>
        <input type="number" id="newItemQty" placeholder="Quantity">
        <button onclick="addNewItem()">Add Item</button>
      </div>
      <div class="muted">Tip: data is saved in this browser using localStorage.</div>
    </section>

    <!-- Adjust Stock Page -->
    <section id="adjustPage" style="display:none;">
      <h2>Adjust Stock</h2>
      <div id="stockGrid" class="grid"></div>
    </section>

    <!-- Goal Settings Page -->
    <section id="goalPage" style="display:none;">
      <h2>Set Stock Count Goal</h2>
      <table id="goalTable">
        <thead>
          <tr><th>Item Name</th><th>Current Goal</th><th>New Goal</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- History Page -->
    <section id="historyPage" style="display:none;">
      <h2>History</h2>
      <div class="toolbar">
        <div class="input-container" style="flex:1; min-width:260px;">
          <input id="hist-search" type="text" class="input" placeholder=" " oninput="renderHistory()">
          <span class="topline"></span><span class="underline"></span>
          <label for="hist-search" class="label">Search item / name / purposeâ€¦</label>
        </div>
        <select id="hist-item-filter" onchange="renderHistory()">
          <option value="">All items</option>
        </select>
        <span class="pill" id="hist-count">0 records</span>
        <div style="flex:1"></div>
        <button onclick="exportHistoryCSV()">Export CSV</button>
        <button onclick="clearHistory()">Clear History</button>
      </div>
      <table id="historyTable">
        <thead>
          <tr>
            <th class="nowrap">Date/Time</th>
            <th>Item</th>
            <th class="nowrap">Change</th>
            <th>Qty After</th>
            <th>By (Name)</th>
            <th>Purpose</th>
            <th>For (names)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted">Only this device/browser can see this history (localStorage).</div>
    </section>
  </main>

  <!-- ===== Adjust dialog ===== -->
  <div id="adjustModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="adj-title">
    <div class="modal-card">
      <h3 id="adj-title">Adjust Stock</h3>
      <div id="adj-subtitle" class="muted"></div>

      <label for="adj-amount">Amount</label>
      <input id="adj-amount" type="number" min="1" step="1" value="1" placeholder="Enter amount">

      <div class="input-container">
        <input id="adj-name" type="text" class="input" placeholder=" ">
        <span class="topline"></span><span class="underline"></span>
        <label for="adj-name" class="label">Your name</label>
      </div>

      <div class="input-container">
        <input id="adj-purpose" type="text" class="input" placeholder=" ">
        <span class="topline"></span><span class="underline"></span>
        <label for="adj-purpose" class="label">Purpose (e.g., pickup / audit / transfer)</label>
      </div>

      <div class="input-container">
        <input id="adj-for" type="text" class="input" placeholder=" ">
        <span class="topline"></span><span class="underline"></span>
        <label for="adj-for" class="label">For (names)</label>
      </div>

      <div class="modal-actions">
        <button id="adj-cancel">Cancel</button>
        <button id="adj-confirm">Confirm</button>
      </div>
    </div>
  </div>

  <!-- ===== Delete dialog ===== -->
  <div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="del-title">
    <div class="modal-card">
      <h3 id="del-title">Delete Item</h3>
      <div id="del-subtitle" class="muted"></div>

      <div class="input-container">
        <input id="del-name" type="text" class="input" placeholder=" ">
        <span class="topline"></span><span class="underline"></span>
        <label for="del-name" class="label">Your name</label>
      </div>

      <div class="input-container">
        <input id="del-purpose" type="text" class="input" placeholder=" ">
        <span class="topline"></span><span class="underline"></span>
        <label for="del-purpose" class="label">Purpose (e.g., discontinued)</label>
      </div>

      <div class="input-container">
        <input id="del-for" type="text" class="input" placeholder=" ">
        <span class="topline"></span><span class="underline"></span>
        <label for="del-for" class="label">For (names)</label>
      </div>

      <div class="modal-actions">
        <button id="del-cancel">Cancel</button>
        <button id="del-confirm" style="background:#111827;color:#fff;">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // keep aria-expanded in sync for the hamburger
    const menuCheck = document.getElementById('menu-check');
    const hamb = document.querySelector('label.hamburger');
    function syncAria(){ hamb.setAttribute('aria-expanded', String(menuCheck.checked)); }
    menuCheck.addEventListener('change', syncAria); syncAria();

    // ===== Data (inventory + audit log) in localStorage =====
    let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
    let adjustments = JSON.parse(localStorage.getItem('adjustments')) || [];

    function saveInventory(){ localStorage.setItem('inventory', JSON.stringify(inventory)); }
    function saveAdjustments(){ localStorage.setItem('adjustments', JSON.stringify(adjustments)); }

    function showPage(pageId) {
      ['addPage','adjustPage','goalPage','historyPage'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
      const target = document.getElementById(pageId);
      if (target) target.style.display = 'block';

      if (pageId === 'adjustPage' || pageId === 'goalPage') renderTables();
      if (pageId === 'historyPage') { populateHistoryFilters(); renderHistory(); }
    }

    // Add new item
    function addNewItem() {
      const name = document.getElementById('newItemName').value.trim();
      const qty  = parseInt(document.getElementById('newItemQty').value);
      if (!name || isNaN(qty) || qty <= 0) return alert("Enter valid name and quantity");

      const existing = inventory.find(i => i.name.toLowerCase() === name.toLowerCase());
      if (existing) existing.qty += qty;
      else inventory.push({ name, qty, goal: 0 });

      saveInventory();
      alert(`Item "${name}" added.`);
      document.getElementById('newItemName').value = '';
      document.getElementById('newItemQty').value = '';
    }

    // Render both adjust grid + goal table
    function renderTables(){ renderStockGrid(); renderGoalTable(); checkLowStockAlerts(); }

    // Adjust grid
    function renderStockGrid() {
      const grid = document.getElementById('stockGrid');
      if (!grid) return;
      grid.innerHTML = '';
      inventory.forEach((item, index) => {
        const low = item.goal > 0 && item.qty <= item.goal;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card__shine"></div>
          <div class="card__glow"></div>
          <div class="card__badge" style="${low ? 'opacity:1; transform:scale(1);' : ''}">
            ${low ? 'LOW' : 'OK'}
          </div>
          <div class="card__content">
            <div class="card__image"><span class="qty-badge">Qty: ${item.qty}</span></div>
            <div class="card__text">
              <h3 class="card__title" title="${escapeHtml(item.name)}">${escapeHtml(item.name)}</h3>
              <p class="card__description">Goal: ${item.goal || 0}</p>
            </div>
            <div class="card__actions">
              <div class="card__button" title="Add" onclick="openAdjustDialog(${index}, 'add')">+</div>
              <div class="card__button card__button--minus" title="Minus" onclick="openAdjustDialog(${index}, 'sub')">â€“</div>
              <div class="card__button card__button--trash" title="Delete item" onclick="openDeleteDialog(${index})">ðŸ—‘</div>
            </div>
          </div>`;
        grid.appendChild(card);
      });
    }

    // Goal table
    function renderGoalTable() {
      const tbody = document.querySelector('#goalTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      inventory.forEach((item, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHtml(item.name)}</td>
          <td>${item.goal}</td>
          <td><input type="number" id="newGoal-${index}" placeholder="New Goal"></td>
          <td><button onclick="updateGoal(${index})">Update</button></td>`;
        tbody.appendChild(row);
      });
    }

    function updateGoal(index) {
      const el = document.getElementById(`newGoal-${index}`);
      const newGoal = parseInt(el.value);
      if (isNaN(newGoal) || newGoal < 0) return alert("Enter valid stock goal");
      inventory[index].goal = newGoal;
      saveInventory(); renderGoalTable();
      alert(`Stock goal updated for ${inventory[index].name}`);
    }

    function checkLowStockAlerts() {
      inventory.forEach(item => {
        if (item.goal > 0 && item.qty <= item.goal) {
          alert(`Low stock for "${item.name}"`);
        }
      });
    }

    // Adjust dialog
    let pending = { index:null, mode:'add' };
    function openAdjustDialog(index, mode) {
      pending = { index, mode };
      const item = inventory[index];
      document.getElementById('adj-title').textContent = `${mode === 'add' ? 'Add to' : 'Minus from'} "${item.name}"`;
      document.getElementById('adj-subtitle').textContent = `Current qty: ${item.qty}`;
      document.getElementById('adj-amount').value = '1';
      document.getElementById('adj-name').value = '';
      document.getElementById('adj-purpose').value = '';
      document.getElementById('adj-for').value = '';
      document.getElementById('adjustModal').classList.add('open');
      setTimeout(() => document.getElementById('adj-amount').focus(), 0);
    }
    function closeAdjustDialog(){ document.getElementById('adjustModal').classList.remove('open'); }
    document.getElementById('adj-cancel').addEventListener('click', closeAdjustDialog);
    document.getElementById('adjustModal').addEventListener('click', e => { if (e.target.id === 'adjustModal') closeAdjustDialog(); });
    document.getElementById('adjustModal').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('adj-confirm').click(); } });
    document.getElementById('adj-confirm').addEventListener('click', () => {
      const amount = parseInt(document.getElementById('adj-amount').value, 10);
      const actor   = document.getElementById('adj-name').value.trim();
      const purpose = document.getElementById('adj-purpose').value.trim();
      const forWhom = document.getElementById('adj-for').value.trim();
      if (!Number.isInteger(amount) || amount <= 0) return alert('Enter a valid positive amount.');
      if (!actor || !purpose || !forWhom) return alert('Please fill in Your name, Purpose, and For (names).');

      const item = inventory[pending.index];
      const signedDelta = pending.mode === 'add' ? amount : -amount;
      item.qty += signedDelta; if (item.qty < 0) item.qty = 0;

      adjustments.push({ ts:new Date().toISOString(), item:item.name, delta:signedDelta, actor, purpose, forWhom, qtyAfter:item.qty });
      saveInventory(); saveAdjustments();
      renderStockGrid(); renderGoalTable();
      if (document.getElementById('historyPage').style.display !== 'none') { populateHistoryFilters(); renderHistory(); }
      checkLowStockAlerts(); closeAdjustDialog();
    });

    // Delete dialog
    let pendingDeleteIndex = null;
    function openDeleteDialog(index) {
      pendingDeleteIndex = index;
      const item = inventory[index];
      document.getElementById('del-title').textContent = `Delete "${item.name}"`;
      document.getElementById('del-subtitle').textContent = `This will remove the item and log a history entry with -${item.qty} (Qty after: 0).`;
      document.getElementById('del-name').value = '';
      document.getElementById('del-purpose').value = '';
      document.getElementById('del-for').value = '';
      document.getElementById('deleteModal').classList.add('open');
      setTimeout(() => document.getElementById('del-name').focus(), 0);
    }
    function closeDeleteDialog(){ document.getElementById('deleteModal').classList.remove('open'); }
    document.getElementById('del-cancel').addEventListener('click', closeDeleteDialog);
    document.getElementById('deleteModal').addEventListener('click', e => { if (e.target.id === 'deleteModal') closeDeleteDialog(); });
    document.getElementById('deleteModal').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('del-confirm').click(); } });
    document.getElementById('del-confirm').addEventListener('click', () => {
      if (pendingDeleteIndex === null) return closeDeleteDialog();
      const actor   = document.getElementById('del-name').value.trim();
      const purpose = document.getElementById('del-purpose').value.trim();
      const forWhom = document.getElementById('del-for').value.trim();
      if (!actor || !purpose || !forWhom) return alert('Please fill in Your name, Purpose, and For (names).');

      const removed = inventory[pendingDeleteIndex];
      const prevQty = removed?.qty ?? 0;
      adjustments.push({ ts:new Date().toISOString(), item:removed.name, delta:-prevQty, actor, purpose, forWhom, qtyAfter:0 });
      inventory.splice(pendingDeleteIndex, 1); pendingDeleteIndex = null;
      saveInventory(); saveAdjustments();
      renderStockGrid(); renderGoalTable(); populateHistoryFilters(); renderHistory();
      closeDeleteDialog();
    });

    // History
    function populateHistoryFilters() {
      const sel = document.getElementById('hist-item-filter');
      if (!sel) return;
      const current = sel.value;
      const names = Array.from(new Set(adjustments.map(a => a.item))).sort((a,b)=>a.localeCompare(b));
      sel.innerHTML = '<option value="">All items</option>' + names.map(n => `<option value="${n}">${n}</option>`).join('');
      if ([...sel.options].some(o => o.value === current)) sel.value = current;
    }
    function renderHistory() {
      const tbody = document.querySelector('#historyTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      let rows = adjustments.slice().sort((a,b)=> (a.ts < b.ts ? 1 : -1));
      const q = (document.getElementById('hist-search').value || '').trim().toLowerCase();
      if (q) rows = rows.filter(r =>
        (r.item||'').toLowerCase().includes(q) ||
        (r.actor||'').toLowerCase().includes(q) ||
        (r.purpose||'').toLowerCase().includes(q) ||
        (r.forWhom||'').toLowerCase().includes(q)
      );
      const itemFilter = document.getElementById('hist-item-filter').value;
      if (itemFilter) rows = rows.filter(r => r.item === itemFilter);
      document.getElementById('hist-count').textContent = `${rows.length} record${rows.length===1?'':'s'}`;
      for (const r of rows) {
        const tr = document.createElement('tr');
        const dt = new Date(r.ts);
        const dtStr = isNaN(+dt) ? r.ts : dt.toLocaleString();
        tr.innerHTML = `
          <td>${dtStr}</td>
          <td>${escapeHtml(r.item)}</td>
          <td class="nowrap">${r.delta > 0 ? '+' : ''}${r.delta}</td>
          <td>${r.qtyAfter}</td>
          <td>${escapeHtml(r.actor)}</td>
          <td>${escapeHtml(r.purpose)}</td>
          <td>${escapeHtml(r.forWhom)}</td>`;
        tbody.appendChild(tr);
      }
    }

    // utils
    function csvEscape(v){ const s = (v ?? '').toString(); return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s; }
    function escapeHtml(s){ return (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    // Initial render
    renderTables();
  </script>
</body>
</html>
